

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>5. 共识算法 &mdash; chainmaker-docs v1.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6. P2P网络" href="P2P%E7%BD%91%E7%BB%9C.html" />
    <link rel="prev" title="4. 智能合约与虚拟机" href="%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E4%B8%8E%E8%99%9A%E6%8B%9F%E6%9C%BA.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> chainmaker-docs
          

          
          </a>

          
            
            
              <div class="version">
                v1.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">长安链介绍:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E5%B9%B3%E5%8F%B0%E7%AE%80%E4%BB%8B.html">1. 长安链底层技术平台简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E8%83%8C%E6%99%AF.html">2. 背景</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E5%9F%BA%E7%A1%80%E6%9C%AF%E8%AF%AD.html">3. 基础术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E7%BC%96%E5%86%99%E8%AF%AD%E8%A8%80.html">4. 编写语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E7%89%88%E6%9C%AC%E8%BF%AD%E4%BB%A3.html">5. 版本迭代</a></li>
</ul>
<p class="caption"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html">1. 概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#id2">2. 环境依赖</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#id5">3. 环境搭建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#id16">4. 功能验证</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#goland">5. 开发-goland启动链</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#id30">6. 常见问题</a></li>
</ul>
<p class="caption"><span class="caption-text">技术设计文档:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.html">1. 整体架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B.html">2. 核心流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html">3. 数据结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E4%B8%8E%E8%99%9A%E6%8B%9F%E6%9C%BA.html">4. 智能合约与虚拟机</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. 共识算法</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">5.1. 共识算法简介</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">5.1.1. 公链共识</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">5.1.2. 联盟链共识</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">5.1.3. 公链共识和联盟链共识的对比</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">5.2. 长安链中的共识</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#solo">5.2.1. Solo</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id7">5.2.1.1. 算法简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">5.2.1.2. 算法用途</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">5.2.1.3. 如何使用算法</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#raft">5.2.2. Raft</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id10">5.2.2.1. 算法简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">5.2.2.2. 算法用途</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">5.2.2.3. 共识接口说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">5.2.2.4. Raft共识与核心引擎交互图</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">5.2.2.5. 如何使用算法</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#tbft">5.2.3. TBFT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id15">5.2.3.1. 算法简述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pbft">5.2.3.2. 与PBFT的区别</a></li>
<li class="toctree-l4"><a class="reference internal" href="#msgbus">5.2.3.3. 与msgbus交互流程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">5.2.3.4. 接口说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">5.2.3.5. 数据结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">5.2.3.6. 配置参数</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#hotstuff">5.2.4. HotStuff</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id19">5.2.4.1. 模块设计</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">5.2.4.2. 配置参数</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="P2P%E7%BD%91%E7%BB%9C.html">6. P2P网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="RPC%E6%9C%8D%E5%8A%A1.html">7. RPC服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8.html">8. 数据存储</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E8%BA%AB%E4%BB%BD%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86.html">9. 身份权限管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95.html">10. 加密算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E4%BA%A4%E6%98%93%E7%BC%93%E5%AD%98.html">11. 交易缓存</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E5%B9%B6%E8%A1%8C%E8%B0%83%E5%BA%A6.html">12. 并行调度</a></li>
</ul>
<p class="caption"><span class="caption-text">开发指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6.html">1. 智能合约</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/SDK.html">2. SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7.html">3. 命令行工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/%E8%AF%81%E4%B9%A6%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7.html">4. 证书生成工具</a></li>
</ul>
<p class="caption"><span class="caption-text">进阶开发</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E5%A4%9A%E6%9C%BA%E9%83%A8%E7%BD%B2.html">1. 多机部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4.html">2. 运维监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E8%87%AA%E6%8B%89%E8%B5%B7%E6%9C%8D%E5%8A%A1.html">3. 自拉起服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E9%85%8D%E7%BD%AE%E5%8F%98%E6%9B%B4.html">4. 配置变更</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/HIBE%E6%8E%A5%E5%8F%A3%E3%80%81%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%E5%8F%8A%E7%94%A8%E4%BE%8B.html">5. HIBE 教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97.html">6. 版本升级操作指南</a></li>
</ul>
<p class="caption"><span class="caption-text">应用场景</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usecase/%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D.html">1. 供应链金融</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usecase/%E7%A2%B3%E4%BA%A4%E6%98%93.html">2. 碳交易</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usecase/%E5%86%B7%E9%93%BE%E6%BA%AF%E6%BA%90.html">3. 冷链溯源</a></li>
</ul>
<p class="caption"><span class="caption-text">关于作者</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../author/%E5%85%B3%E4%BA%8E%E4%BD%9C%E8%80%85.html">1. 关于作者</a></li>
</ul>
<p class="caption"><span class="caption-text">鸣谢</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../thanks/%E9%B8%A3%E8%B0%A2.html">1. 鸣谢</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">chainmaker-docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">5. </span>共识算法</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tech/共识算法.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1><span class="section-number">5. </span>共识算法<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2><span class="section-number">5.1. </span>共识算法简介<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>共识算法是指在分布式场景中，多个节点为了达成相同的数据状态而运行的一种分布式算法。
在分布式场景中，可能出现网络丢包、时钟漂移、节点宕机、节点作恶等等故障情况，共识算法需要能够容忍这些错误，保证多个节点取得相同的数据状态。</p>
<p>根据可容忍的故障类型的不同，可以将共识算法分为两类：</p>
<ul class="simple">
<li><p>容忍宕机错误类算法（crash fault tolerant consensus algorithm），可以容忍网络丢包、时钟漂移、部分节点宕机这种节点为良性的错误。常见算法有 Paxos、Raft。</p></li>
<li><p>容忍拜占庭错误类算法（byzantine fault tolerant consensus algorithm），可以容忍部分节点任意类型错误，包括节点作恶的情况。常见算法有 PBFT、PoW、PoS等。</p></li>
</ul>
<p>根据使用场景的不同，又可将共识算法分为公链共识、联盟链共识两类。</p>
<div class="section" id="id3">
<h3><span class="section-number">5.1.1. </span>公链共识<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>公链的特点是节点数量多且节点分布分散，主要使用的共识算法有PoW和PoS，这两种共识的优点是可以支持的节点数量多，缺点是TPS较低和交易确认时间长。</p>
</div>
<div class="section" id="id4">
<h3><span class="section-number">5.1.2. </span>联盟链共识<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>联盟链的特点是节点之间网络较为稳定且节点有准入要求，根据需要容忍的错误类型可以选择Raft和PBFT类算法，这类算法的优点是TPS较高且交易可以在毫秒级确认，缺点是支持的节点数量有限，通常不多于100个节点。</p>
</div>
<div class="section" id="id5">
<h3><span class="section-number">5.1.3. </span>公链共识和联盟链共识的对比<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th>共识</th>
<th>支持的节点数量</th>
<th>TPS</th>
<th>交易时延</th>
</tr>
</thead>
<tbody>
<tr>
<td>公有链共识</td>
<td>10000+</td>
<td>10+</td>
<td>10min+</td>
</tr>
<tr>
<td>联盟链共识</td>
<td>100+</td>
<td>1000+</td>
<td>1s+</td>
</tr>
</tbody>
</table></div>
</div>
<div class="section" id="id6">
<h2><span class="section-number">5.2. </span>长安链中的共识<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>长安链1.0开源版本目前支持Solo，Raft，TBFT 三种共识类型。三种共识对比如下：</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>共识类型</th>
<th>故障节点数为n(n&gt;=0)时，网络中最少节点数</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>Solo</td>
<td>Solo只支持1个节点</td>
<td>主要用于测试及搭建demo</td>
</tr>
<tr>
<td>Raft</td>
<td>2n+1</td>
<td>联盟链中不需要考虑恶意节点，且需要性能较高的场景</td>
</tr>
<tr>
<td>TBFT</td>
<td>3n+1</td>
<td>联盟链中需要考虑恶意节点的场景</td>
</tr>
<tr>
<td>HotStuff</td>
<td>3n+1</td>
<td>联盟链中需要考虑恶意节点的场景</td>
</tr>
</tbody>
</table><div class="section" id="solo">
<h3><span class="section-number">5.2.1. </span>Solo<a class="headerlink" href="#solo" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id7">
<h4><span class="section-number">5.2.1.1. </span>算法简介<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>SOLO是单节点无共识投票过程的“共识算法”。</p>
</div>
<div class="section" id="id8">
<h4><span class="section-number">5.2.1.2. </span>算法用途<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li><p>快速部署单节点运行，降低试用门槛；</p></li>
<li><p>供开发人员进行除网络和共识模块的全流程测试。</p></li>
</ol>
</div>
<div class="section" id="id9">
<h4><span class="section-number">5.2.1.3. </span>如何使用算法<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>部署一个长安链节点，将链配置的共识算法进行如下修改，清除数据启动即可：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1">#共识配置</span>
consensus:
  <span class="c1"># 共识类型(0-SOLO,1-TBFT,2-MBFT,3-HOTSTUFF,4-RAFT,10-POW)</span>
  type: <span class="m">0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="raft">
<h3><span class="section-number">5.2.2. </span>Raft<a class="headerlink" href="#raft" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id10">
<h4><span class="section-number">5.2.2.1. </span>算法简介<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Raft_(algorithm)">Raft算法</a>是目前使用最广泛的非拜占庭容错类共识算法。
Raft算法主要依靠投票机制和日志复制机制来实现节点间的共识。节点通过投票选出一个leader，由leader负责处理所有请求，再将请求以日志的方式复制到其他节点。</p>
</div>
<div class="section" id="id11">
<h4><span class="section-number">5.2.2.2. </span>算法用途<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li><p>不考虑恶意节点的多节点环境；</p></li>
<li><p>需要支持高TPS的环境。</p></li>
</ol>
</div>
<div class="section" id="id12">
<h4><span class="section-number">5.2.2.3. </span>共识接口说明<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>Raft 实现了长安链的ConsensusEngine接口。
Start 方法用来初始化Raft内部状态及启动Raft实例。
Stop 方法用来停止Raft实例。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">ConsensusEngine</span> <span class="kd">interface</span> <span class="p">{</span>      
  <span class="c1">// Init starts the consensus engine.</span>
  <span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span>                       
                                      
  <span class="c1">// Stop stops the consensus engine. </span>
  <span class="nx">Stop</span><span class="p">()</span> <span class="kt">error</span>                        
<span class="p">}</span>  
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h4><span class="section-number">5.2.2.4. </span>Raft共识与核心引擎交互图<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>流程图如下：
<br><img src="../images/共识算法-Raft共识与核心引擎交互图.png" alt="Raft共识与核心引擎交互图" style="zoom:60%;"/></p>
</div>
<div class="section" id="id14">
<h4><span class="section-number">5.2.2.5. </span>如何使用算法<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>Raft共识建议配置节点数为2n+1(n&gt;=0)，将链配置（参见配置模块，链配置章节）的共识算法进行如下修改，清除数据启动即可：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1">#共识配置</span>
consensus:
  <span class="c1"># 共识类型(0-SOLO,1-TBFT,2-MBFT,3-HOTSTUFF,4-RAFT,10-POW)</span>
  type: <span class="m">4</span>
  nodes:                                                                                                                                 
    - org_id: <span class="s2">&quot;wx-org1.chainmaker.org&quot;</span>                                                                                                   
      node_id:                                                                                                                           
        - <span class="s2">&quot;QmcQHCuAXaFkbcsPUj7e37hXXfZ9DdN7bozseo5oX4qiC4&quot;</span>                                                  
    - org_id: <span class="s2">&quot;wx-org2.chainmaker.org&quot;</span>                                                                                                   
      node_id:                                                                                                                           
        - <span class="s2">&quot;QmeyNRs2DwWjcHTpcVHoUSaDAAif4VQZ2wQDQAUNDP33gH&quot;</span>                                                  
    - org_id: <span class="s2">&quot;wx-org3.chainmaker.org&quot;</span>                                                                                                   
      node_id:                                                                                                                           
        - <span class="s2">&quot;QmXf6mnQDBR9aHauRmViKzSuZgpumkn7x6rNxw1oqqRr45&quot;</span>                                                  
</pre></div>
</div>
</div>
</div>
<div class="section" id="tbft">
<h3><span class="section-number">5.2.3. </span>TBFT<a class="headerlink" href="#tbft" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id15">
<h4><span class="section-number">5.2.3.1. </span>算法简述<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>TBFT 是一种拜占庭容错的共识算法，可以在拜占庭节点数小于总数1/3的情况下，保证系统的安全运行。
TBFT 的每轮共识可以分为5个步骤：</p>
<ol class="simple">
<li><p>NewRound: 共识投票的准备阶段，会初始化共识相关状态；</p></li>
<li><p>Proposal: 提案阶段，leader节点会打包区块，并广播给follwer节点；</p></li>
<li><p>Prevote: 预投票阶段，follower节点在收到proposal并验证proposal合法后，广播自己的prevote投票到其他节点；</p></li>
<li><p>Precommit: 预提交阶段，节点收到 &gt;2/3 针对proposal的prevote投票后，广播自己的precommit投票到其他节点；</p></li>
<li><p>Commit: 提交阶段，节点收到 &gt;2/3 针对proposal的precommit投票后，提交proposal中的区块到账本。</p></li>
</ol>
<p>其中共识投票是指其中的Proposal，Prevote，Precommit三个阶段。 阶段图示如下：
<br><img src="../images/共识算法-tbft算法阶段图.png" alt="Raft共识与核心引擎交互图" style="width:800px;"/></p>
<p>流程图如下：
<br><img src="../images/共识算法-tbft流程图.png" alt="Raft共识与核心引擎交互图" style="zoom:70%;"/></p>
</div>
<div class="section" id="pbft">
<h4><span class="section-number">5.2.3.2. </span>与PBFT的区别<a class="headerlink" href="#pbft" title="Permalink to this headline">¶</a></h4>
<p>TBFT基于Tendermint算法，与PBFT的最大区别在于：PBFT有一个固定的leader节点打包交易，当leader节点故障的时候会
使用view-change子协议更换leader；而在TBFT中，leader是轮换的，每提交n个块（可以配置）leader会轮换成下一个节点。
因此，TBFT比PBFT有更好的公平性。</p>
</div>
<div class="section" id="msgbus">
<h4><span class="section-number">5.2.3.3. </span>与msgbus交互流程<a class="headerlink" href="#msgbus" title="Permalink to this headline">¶</a></h4>
<img src="../images/共识算法-tbft与msgbus交互图.png" alt="Raft共识与核心引擎交互图" style="zoom:80%;"/><p><code class="docutils literal notranslate"><span class="pre">ProposaState</span></code>: TBFT发送给核心引擎本节点在当前高度是否是leader节点，核心引擎判断是否需要打包区块 <br>
<code class="docutils literal notranslate"><span class="pre">Proposal</span></code>: 核心引擎打包区块并发送给TBFT <br>
<code class="docutils literal notranslate"><span class="pre">Verify</span></code>: 当本节点收到主节点发来的区块后，向核心引擎验证区块读写集等信息 <br>
<code class="docutils literal notranslate"><span class="pre">VerifyResult</span></code>: 核心引擎返回给TBFT Verify的结果，当区块合法时，本节点将会投票给区块 <br>
<code class="docutils literal notranslate"><span class="pre">Commit</span></code>: TBFT完成共识后，向核心引擎发送提交区块的信号，核心引擎提交区块到账本 <br>
<code class="docutils literal notranslate"><span class="pre">BlockInfo</span></code>: 核心引擎告知TBFT已提交区块的高度等信息，TBFT进入下一个高度 <br></p>
</div>
<div class="section" id="id16">
<h4><span class="section-number">5.2.3.4. </span>接口说明<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>TBFT 实现了长安链的<code class="docutils literal notranslate"><span class="pre">ConsensusEngine</span></code>接口。 <br>
<code class="docutils literal notranslate"><span class="pre">Start</span></code> 方法用来初始化TBFT内部状态及启动TBFT实例。 <br>
<code class="docutils literal notranslate"><span class="pre">Stop</span></code> 方法用来停止TBFT实例。 <br></p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">ConsensusEngine</span> <span class="kd">interface</span> <span class="p">{</span>      
  <span class="c1">// Init starts the consensus engine.</span>
  <span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span>                       
                                      
  <span class="c1">// Stop stops the consensus engine. </span>
  <span class="nx">Stop</span><span class="p">()</span> <span class="kt">error</span>                        
<span class="p">}</span>    
</pre></div>
</div>
</div>
<div class="section" id="id17">
<h4><span class="section-number">5.2.3.5. </span>数据结构<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="c1">// TBFTMsgType defines different type message in tbft</span>
<span class="kd">enum</span> <span class="n">TBFTMsgType</span> <span class="p">{</span>
  <span class="na">propose</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">prevote</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="na">precommit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="na">state</span>     <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">TBFTMsg</span> <span class="p">{</span>
  <span class="n">TBFTMsgType</span> <span class="na">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">bytes</span> <span class="na">msg</span>        <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Proposal defined a consesensus proposal which can </span>
<span class="c1">// be gossiped to other node and can be serilized </span>
<span class="c1">// for persistent store.</span>
<span class="kd">message</span> <span class="nc">Proposal</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">voter</span>                 <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int64</span> <span class="na">height</span>                 <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">round</span>                  <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">pol_round</span>              <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">Block</span> <span class="na">block</span>                  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">EndorsementEntry</span> <span class="na">endorsement</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// VoteType represents the type of vote</span>
<span class="kd">enum</span> <span class="n">VoteType</span> <span class="p">{</span>
  <span class="na">VotePrevote</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">VotePrecommit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Vote represents a tbft vote</span>
<span class="kd">message</span> <span class="nc">Vote</span> <span class="p">{</span>
  <span class="n">VoteType</span> <span class="na">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">voter</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int64</span> <span class="na">height</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">round</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">bytes</span> <span class="na">hash</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">EndorsementEntry</span> <span class="na">endorsement</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Step represents the step in a round </span>
<span class="kd">enum</span> <span class="n">Step</span> <span class="p">{</span>
  <span class="na">NewHeight</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">NewRound</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="na">Propose</span>       <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="na">Prevote</span>       <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="na">PrevoteWait</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="na">Precommit</span>     <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="na">PrecommitWait</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
  <span class="na">Commit</span>        <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id18">
<h4><span class="section-number">5.2.3.6. </span>配置参数<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p>TBFT 可以通过在配置块中的<code class="docutils literal notranslate"><span class="pre">ext_config</span></code>字段配置相关参数：</p>
<ol class="simple">
<li><p>“TBFT_propose_timeout”: 提案的超时时间，如<code class="docutils literal notranslate"><span class="pre">10s</span></code>, <code class="docutils literal notranslate"><span class="pre">1m</span></code>；</p></li>
<li><p>“TBFT_propose_delta_timeout”: 每轮提案超时增加的时间，如<code class="docutils literal notranslate"><span class="pre">10s</span></code>, <code class="docutils literal notranslate"><span class="pre">1m</span></code>；</p></li>
<li><p>“TBFT_blocks_per_proposer”: 每个节点连续出块数，如 <code class="docutils literal notranslate"><span class="pre">3</span></code>。</p></li>
</ol>
</div>
</div>
<div class="section" id="hotstuff">
<h3><span class="section-number">5.2.4. </span>HotStuff<a class="headerlink" href="#hotstuff" title="Permalink to this headline">¶</a></h3>
<p>chainedbft模块实现了流水线hotstuff共识，是一种优化后的三阶段bft算法，在拜占庭节点数小于总数1/3时，保证系统的安全运行，同时提供更加高效的运行效率；在如下方面进行了优化：</p>
<ul class="simple">
<li><p>优化投票流程，使用星型网络减少网络通信量至O(n)</p></li>
<li><p>简化共识消息类型为 proposalMsg、voteMsg</p></li>
<li><p>liveness和safty解耦，方便拓展实现</p></li>
</ul>
<p>hotstuff是一种基于view的共识算法，每个view又称为level，每次进行level切换时，可以更新下一个level的proposer，且具有如下特性；</p>
<ul class="simple">
<li><p>共识算法运转过程中，存在两个全局累加的变量：区块高度、共识level，指定高度的区块可能经历多轮共识才达成一致，当节点生成有效区块或当前共识level被投超时票后，共识level都会递增</p></li>
<li><p>流水线的hotstuff共识算法中，对当前共识level区块的投票会发送下一个共识level的proposer节点，由下一个level的proposer收集投票信息组成QC，包含在新生成的区块中</p></li>
<li><p>hotstuff共识算法为三阶段协议：prepareQC、precommitQC、commitQC</p>
<ul>
<li><p>在流水线模式的实现中，当前区块的QC是由下一个view的leader节点收集，包含在下一个区块中；且由于每一阶段都是对指定消息的投票收集，因为对协议进行了如下优化</p></li>
<li><p>prepareQC：链上验证者集合对当前view提案的第一轮共识投票，包含在下一轮共识view+1的提案中，当节点收到view+1提案消息时，表示对view的第一轮共识达成</p></li>
<li><p>precommitQC/lockedQC：共识view的precommitQC是由view+1的prepareQC间接确认的，即当view+2的leader将验证者集合对view+1的共识投票包含在新提案中，其它节点收到view+2提案时，表示对view+1的prepareQC达成，对view的precommitQC达成</p></li>
<li><p>commitQC：与precommitQC的达成类似，view的commitQC是通过对view+2的prepareQC间接达成的；当节点收到view+3的提案时，表示链上验证集合对view的commitQC达成，此时会将view的提案在链上提交</p></li>
<li><p>因此流水线的hotstuff实现中，节点会缓存三个共识view(view、view+1、view+2)待提交的提案信息，直到收到view+3提案时，将view的提案进行提交</p></li>
</ul>
</li>
<li><p>经过流水线hotstutff的共识优化，投票类型仅包含对于接收的<strong>proposal</strong>消息的投票或共识超时后的<strong>NewView</strong>消息投票</p></li>
</ul>
<p><strong>名字解释</strong></p>
<ul class="simple">
<li><p>QC(quorum certificate)：(n−f)个节点对指定proposal消息的签名投票集合。</p></li>
<li><p>TC(timeout quorum certificate)：(n−f)个节点对共识view的超时消息的签名投票集合。</p></li>
</ul>
<img src="../images/共识算法-pipieline-hotstuff.png"  alt="hotstuff-投票处理" style="zoom:100%;"/><div class="section" id="id19">
<h4><span class="section-number">5.2.4.1. </span>模块设计<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>共识模块主要由几个组件组成，分别是：状态机<code class="docutils literal notranslate"><span class="pre">chainedbftSMR</span></code>、安全服务<code class="docutils literal notranslate"><span class="pre">SafetyRules</span></code>、活性服务<code class="docutils literal notranslate"><span class="pre">Pacemaker</span></code>、信息同步<code class="docutils literal notranslate"><span class="pre">syncManager</span></code>、定时器服务<code class="docutils literal notranslate"><span class="pre">TimerService</span></code>，互相配合在<code class="docutils literal notranslate"><span class="pre">ConsensusChainedBftImpl</span></code>中实现了Hotstuff协议。</p>
<ul class="simple">
<li><p>chainedbftSMR：用来管理节点的状态，保存节点的投票、QC信息等</p></li>
<li><p>SafetyRules：验证节点接收的proposal消息的有效性</p></li>
<li><p>Pacemaker：共识活性服务，使用接收到的QC/TC信息，推进节点的共识状态</p></li>
<li><p>syncManager：在共识过程中，如果负责落后节点的信息同步，将其更新至最新链上最新状态</p></li>
<li><p>TimerService: 定时器服务，当共识切换或生成区块时，添加定时任务，执行超时监测</p></li>
<li><p>ConsensusChainedBftImpl：将各个模块组合起来，实现流水线hotstuff共识</p></li>
</ul>
</div>
<div class="section" id="id20">
<h4><span class="section-number">5.2.4.2. </span>配置参数<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li><p>HOTSTUFF_round_timeout_milli：共识view切换的基础超时时间</p></li>
<li><p>HOTSTUFF_round_timeout_delta_milli：相同区块高度下，每次共识超时后增加的delta时间</p></li>
<li><p>HOTSTUFF_proposer_timeout_milli：proposer生成区块时基础的超时时间</p></li>
<li><p>HOTSTUFF_proposer_timeout_delta_milli：proposer生成区块时，每次超时后增加的delta时间</p></li>
</ol>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="P2P%E7%BD%91%E7%BB%9C.html" class="btn btn-neutral float-right" title="6. P2P网络" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E4%B8%8E%E8%99%9A%E6%8B%9F%E6%9C%BA.html" class="btn btn-neutral float-left" title="4. 智能合约与虚拟机" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright chainmaker.org.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>