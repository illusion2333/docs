

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>1. 智能合约 &mdash; chainmaker-docs v1.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. SDK" href="SDK.html" />
    <link rel="prev" title="12. 并行调度" href="../tech/%E5%B9%B6%E8%A1%8C%E8%B0%83%E5%BA%A6.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> chainmaker-docs
          

          
          </a>

          
            
            
              <div class="version">
                v1.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">长安链介绍:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E5%B9%B3%E5%8F%B0%E7%AE%80%E4%BB%8B.html">1. 长安链底层技术平台简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E8%83%8C%E6%99%AF.html">2. 背景</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E5%9F%BA%E7%A1%80%E6%9C%AF%E8%AF%AD.html">3. 基础术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E7%BC%96%E5%86%99%E8%AF%AD%E8%A8%80.html">4. 编写语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/%E7%89%88%E6%9C%AC%E8%BF%AD%E4%BB%A3.html">5. 版本迭代</a></li>
</ul>
<p class="caption"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html">1. 概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#id2">2. 环境依赖</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#id5">3. 环境搭建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#id16">4. 功能验证</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#goland">5. 开发-goland启动链</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html#id30">6. 常见问题</a></li>
</ul>
<p class="caption"><span class="caption-text">技术设计文档:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.html">1. 整体架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B.html">2. 核心流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html">3. 数据结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E4%B8%8E%E8%99%9A%E6%8B%9F%E6%9C%BA.html">4. 智能合约与虚拟机</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95.html">5. 共识算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/P2P%E7%BD%91%E7%BB%9C.html">6. P2P网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/RPC%E6%9C%8D%E5%8A%A1.html">7. RPC服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8.html">8. 数据存储</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E8%BA%AB%E4%BB%BD%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86.html">9. 身份权限管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95.html">10. 加密算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E4%BA%A4%E6%98%93%E7%BC%93%E5%AD%98.html">11. 交易缓存</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/%E5%B9%B6%E8%A1%8C%E8%B0%83%E5%BA%A6.html">12. 并行调度</a></li>
</ul>
<p class="caption"><span class="caption-text">开发指南</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. 智能合约</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#c">1.1. 使用C++进行智能合约开发</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#docker">1.1.1. 用Docker镜像进行开发</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">1.1.1.1. 框架描述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">1.1.1.2. 示例代码说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.1.1.3. 代码编写规则</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">1.1.1.4. 编译说明</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">1.1.2. 合约发布过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">1.1.3. 合约调用过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-sdk-api">1.1.4. C++ SDK API描述</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#go-tinygo">1.2. 使用Go(TinyGo)进行智能合约开发</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">1.2.1. 使用Docker镜像进行合约开发</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">1.2.1.1. 示例代码说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">1.2.1.2. 代码编写规则</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">1.2.1.3. 编译说明</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id12">1.2.2. 合约发布过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">1.2.3. 合约调用过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#go-sdk-api">1.2.4. Go SDK API描述</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">1.2.4.1. 用户与链交互接口</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#rust">1.3. 使用Rust进行智能合约开发</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">1.3.1. 使用Docker镜像进行合约开发</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id16">1.3.1.1. 框架描述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">1.3.1.2. 示例代码说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">1.3.1.3. 代码编写规则</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">1.3.1.4. 编译说明</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id20">1.3.2. 合约发布过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id21">1.3.3. 合约调用过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rust-sdk-api-span-id-api-span">1.3.4. Rust SDK API描述 <span id="api"></span></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id22">1.3.4.1. 内置链交互接口</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id23">1.3.4.2. 用户与链交互接口</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id24">1.3.5. 约束条件和已知问题</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#solidity">1.4. 使用Solidity进行智能合约开发</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id25">1.4.1. 合约开发</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dockerevm">1.4.1.1. 通过Docker执行evm步骤</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id26">1.4.2. 示例代码说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id27">1.4.3. 合约发布过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id28">1.4.4. 合约调用过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#evm">1.4.5. EVM地址说明</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="SDK.html">2. SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7.html">3. 命令行工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E8%AF%81%E4%B9%A6%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7.html">4. 证书生成工具</a></li>
</ul>
<p class="caption"><span class="caption-text">进阶开发</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E5%A4%9A%E6%9C%BA%E9%83%A8%E7%BD%B2.html">1. 多机部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4.html">2. 运维监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E8%87%AA%E6%8B%89%E8%B5%B7%E6%9C%8D%E5%8A%A1.html">3. 自拉起服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E9%85%8D%E7%BD%AE%E5%8F%98%E6%9B%B4.html">4. 配置变更</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/HIBE%E6%8E%A5%E5%8F%A3%E3%80%81%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%E5%8F%8A%E7%94%A8%E4%BE%8B.html">5. HIBE 教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97.html">6. 版本升级操作指南</a></li>
</ul>
<p class="caption"><span class="caption-text">应用场景</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usecase/%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D.html">1. 供应链金融</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usecase/%E7%A2%B3%E4%BA%A4%E6%98%93.html">2. 碳交易</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usecase/%E5%86%B7%E9%93%BE%E6%BA%AF%E6%BA%90.html">3. 冷链溯源</a></li>
</ul>
<p class="caption"><span class="caption-text">关于作者</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../author/%E5%85%B3%E4%BA%8E%E4%BD%9C%E8%80%85.html">1. 关于作者</a></li>
</ul>
<p class="caption"><span class="caption-text">鸣谢</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../thanks/%E9%B8%A3%E8%B0%A2.html">1. 鸣谢</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">chainmaker-docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">1. </span>智能合约</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/dev/智能合约.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1><span class="section-number">1. </span>智能合约<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>ChainMaker目前已经支持使用C++、Go、Rust进行智能合约开发，很快将支持Solidity和JavaScript。</p>
<div class="section" id="c">
<h2><span class="section-number">1.1. </span>使用C++进行智能合约开发<a class="headerlink" href="#c" title="Permalink to this headline">¶</a></h2>
<p>读者对象：本章节主要描述使用C++进行ChainMaker合约编写的方法，主要面向于使用C++进行ChainMaker的合约开发的开发者。</p>
<div class="section" id="docker">
<h3><span class="section-number">1.1.1. </span>用Docker镜像进行开发<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h3>
<p>ChainMaker官方已经将容器发布至GitHub</p>
<p>拉取镜像</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker pull chainmakeroffcial/chainmaker-cpp-contract:1.1.0
</pre></div>
</div>
<p>请指定你本机的工作目录$WORK_DIR，例如C:\tmp，挂载到docker容器中以方便后续进行必要的一些文件拷贝</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker run -it --name chainmaker-cpp-contract -v <span class="nv">$WORK_DIR</span>:/home chainmakeroffcial/chainmaker-cpp-contract:1.1.0 bash
<span class="c1"># 或者先后台启动</span>
docker run -d --name chainmaker-cpp-contract -v <span class="nv">$WORK_DIR</span>:/home chainmakeroffcial/chainmaker-cpp-contract:1.1.0 bash -c <span class="s2">&quot;while true; do echo hello world; sleep 5;done&quot;</span>
<span class="c1"># 再进入容器</span>
docker <span class="nb">exec</span> -it chainmaker-cpp-contract /bin/sh
</pre></div>
</div>
<p>编译合约</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /home/
tar xvf /data/contract_cpp_template.tar.gz
<span class="nb">cd</span> contract_cpp
emmake make
</pre></div>
</div>
<p>生成合约的字节码文件在</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">contract_cpp</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">wasm</span>
</pre></div>
</div>
<p>通过本地模拟环境运行合约(首次编译运行合约可能需要10秒左右，下面以存证作为示例)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># wxvm main.wasm save time 20210304 file_hash 12345678 file_name a.txt

2021-03-25 09:10:36.441      [DEBUG] [Vm]    xvm/context_service.go:257      wxvm log &gt;&gt;[1234567890123456789012345678901234567890123456789012345678901234] [1] call save() tx_id:
2021-03-25 09:10:36.463 [DEBUG] [Vm]    xvm/context_service.go:257      wxvm log &gt;&gt;[1234567890123456789012345678901234567890123456789012345678901234] [1] call save() file_hash:12345678
2021-03-25 09:10:36.464 [DEBUG] [Vm]    xvm/context_service.go:257      wxvm log &gt;&gt;[1234567890123456789012345678901234567890123456789012345678901234] [1] call save() file_name:a.txt
2021-03-25 09:10:36.465 [DEBUG] [Vm]    xvm/context_service.go:257      wxvm log &gt;&gt;[1234567890123456789012345678901234567890123456789012345678901234] [1] put success: a.txt 12345678
2021-03-25 09:10:36.466 [DEBUG] [Vm]    xvm/context_service.go:257      wxvm log &gt;&gt;[1234567890123456789012345678901234567890123456789012345678901234] [1] save====================================end
2021-03-25 09:10:36.467 [DEBUG] [Vm]    xvm/context_service.go:257      wxvm log &gt;&gt;[1234567890123456789012345678901234567890123456789012345678901234] [1] 
2021-03-25 09:10:36.467 [DEBUG] [Vm]    xvm/context_service.go:257      wxvm log &gt;&gt;[1234567890123456789012345678901234567890123456789012345678901234] [1] result:  a.txt 12345678
2021-03-25 09:10:36.469 [INFO]  [Vm] @chain01   main/main.go:31 contractResult :result:&quot; a.txt 12345678&quot;
</pre></div>
</div>
<p>其中存证的合约方法定义为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;chainmaker/chainmaker.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">chainmaker</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Counter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Contract</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="p">...</span>
	<span class="p">...</span>
    <span class="kt">void</span> <span class="n">save</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">context</span><span class="p">();</span>

        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_hash</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_name</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tx_id</span><span class="p">;</span>

        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">,</span> <span class="n">file_hash</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;file_name&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;tx_id&quot;</span><span class="p">,</span> <span class="n">tx_id</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;call save() tx_id:&quot;</span> <span class="o">+</span> <span class="n">tx_id</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;call save() file_hash:&quot;</span> <span class="o">+</span> <span class="n">file_hash</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;call save() file_name:&quot;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">emit_event</span><span class="p">(</span><span class="s">&quot;topic_vx&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">file_hash</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">file_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">test_str</span> <span class="o">=</span> <span class="n">tx_id</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">file_hash</span><span class="p">;</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">put_object</span><span class="p">(</span><span class="n">file_hash</span><span class="p">,</span> <span class="n">test_str</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;put success:&quot;</span> <span class="o">+</span> <span class="n">test_str</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;save====================================end&quot;</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value_str</span><span class="p">;</span>
        <span class="n">EasyCodecItems</span> <span class="o">*</span><span class="n">value_items</span><span class="p">;</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">get_object</span><span class="p">(</span><span class="n">file_hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
        <span class="n">value_items</span> <span class="o">=</span> <span class="n">easy_unmarshal</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
        <span class="n">value_str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">value_items</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;value&quot;</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;result: &quot;</span> <span class="o">+</span> <span class="n">value_str</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">(</span><span class="n">test_str</span><span class="p">);</span>
        <span class="k">delete</span> <span class="p">(</span><span class="n">value_items</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="n">WASM_EXPORT</span> <span class="kt">void</span> <span class="n">save</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Counter</span> <span class="n">counter</span><span class="p">;</span>
    <span class="n">counter</span><span class="p">.</span><span class="n">save</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id2">
<h4><span class="section-number">1.1.1.1. </span>框架描述<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>解压缩contract_cpp_template.tar.gz后，文件描述如下：</p>
<ul class="simple">
<li><p>chainmaker</p>
<ul>
<li><p>basic_iterator.cc：  迭代器实现</p></li>
<li><p>basic_iterator.h： 迭代器头文件声明</p></li>
<li><p>chainmaker.h： sdk主要接口头文件声明，详情见<a class="reference external" href="#sdk-api">SDK API描述</a></p></li>
<li><p>context_impl.cc：  与链交互接口实现</p></li>
<li><p>context_impl.h：  与链交互头文件声明</p></li>
<li><p>contract.cc： 合约基础工具类</p></li>
<li><p>error.h： 异常处理类</p></li>
<li><p>exports.js：  编译合约导出函数</p></li>
<li><p>safemath.h：  assert异常处理</p></li>
<li><p>syscall.cc： 与链交互入口</p></li>
<li><p>syscall.h：  与链交互头文件声明</p></li>
</ul>
</li>
<li><p>pb</p>
<ul>
<li><p>contract.pb.cc：与链交互数据协议</p></li>
<li><p>contract.pb.h：与链交互数据协议头文件声明</p></li>
</ul>
</li>
<li><p>main.cc： 用户写合约入口，<a class="reference external" href="#fact">如下</a></p></li>
<li><p>Makefile： 常用build命令</p></li>
</ul>
</div>
<div class="section" id="id3">
<h4><span class="section-number">1.1.1.2. </span>示例代码说明<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>存证合约示例：main.cc，实现功能：</p>
<p>1、存储文件哈希和文件名称和该交易的ID</p>
<p>2、通过文件哈希查询该条记录</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;chainmaker/chainmaker.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">chainmaker</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Counter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Contract</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">init_contract</span><span class="p">()</span> <span class="p">{}</span>
    <span class="kt">void</span> <span class="n">upgrade</span><span class="p">()</span> <span class="p">{}</span>
    <span class="c1">// 保存</span>
    <span class="kt">void</span> <span class="n">save</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 获取SDK 接口上下文</span>
        <span class="n">Context</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">context</span><span class="p">();</span>
        <span class="c1">// 定义变量</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">time</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_hash</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_name</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tx_id</span><span class="p">;</span>
		<span class="c1">// 获取参数</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">,</span> <span class="n">file_hash</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;file_name&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;tx_id&quot;</span><span class="p">,</span> <span class="n">tx_id</span><span class="p">);</span>
        <span class="c1">// 发送合约事件</span>
        <span class="c1">// 向topic:&quot;topic_vx&quot;发送2个event数据，file_hash,file_name</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">emit_event</span><span class="p">(</span><span class="s">&quot;topic_vx&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">file_hash</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">file_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
		<span class="c1">// 存储数据</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">put_object</span><span class="p">(</span><span class="s">&quot;fact&quot;</span><span class="o">+</span> <span class="n">file_hash</span><span class="p">,</span>  <span class="n">tx_id</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">file_hash</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">file_name</span><span class="p">);</span>
        <span class="c1">// 记录日志</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;call save() result:&quot;</span> <span class="o">+</span> <span class="n">tx_id</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">file_hash</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">file_name</span><span class="p">);</span>
        <span class="c1">// 返回结果</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">(</span><span class="n">tx_id</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">file_hash</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">file_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 查询</span>
    <span class="kt">void</span> <span class="n">find_by_file_hash</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 获取SDK 接口上下文</span>
    	<span class="n">Context</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">context</span><span class="p">();</span>

		<span class="c1">// 获取参数</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_hash</span><span class="p">;</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">,</span> <span class="n">file_hash</span><span class="p">);</span>
		
        <span class="c1">// 查询数据</span>
    	<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">;</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">get_object</span><span class="p">(</span><span class="s">&quot;fact&quot;</span><span class="o">+</span> <span class="n">file_hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
        <span class="c1">// 记录日志</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;call find_by_file_hash()-&quot;</span> <span class="o">+</span> <span class="n">file_hash</span> <span class="o">+</span> <span class="s">&quot;,result:&quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">);</span>
        <span class="c1">// 返回结果</span>
        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="c1">// 在创建本合约时, 调用一次init方法. ChainMaker不允许用户直接调用该方法.</span>
<span class="n">WASM_EXPORT</span> <span class="kt">void</span> <span class="n">init_contract</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Counter</span> <span class="n">counter</span><span class="p">;</span>
    <span class="n">counter</span><span class="p">.</span><span class="n">init_contract</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// 在升级本合约时, 对于每一个升级的版本调用一次upgrade方法. ChainMaker不允许用户直接调用该方法.</span>
<span class="n">WASM_EXPORT</span> <span class="kt">void</span> <span class="n">upgrade</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Counter</span> <span class="n">counter</span><span class="p">;</span>
    <span class="n">counter</span><span class="p">.</span><span class="n">upgrade</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">WASM_EXPORT</span> <span class="kt">void</span> <span class="n">save</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Counter</span> <span class="n">counter</span><span class="p">;</span>
    <span class="n">counter</span><span class="p">.</span><span class="n">save</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">WASM_EXPORT</span> <span class="kt">void</span> <span class="n">find_by_file_hash</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Counter</span> <span class="n">counter</span><span class="p">;</span>
    <span class="n">counter</span><span class="p">.</span><span class="n">find_by_file_hash</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4><span class="section-number">1.1.1.3. </span>代码编写规则<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p><strong>对链暴露方法写法为：</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">WASM_EXPORT</span></code>： 必须，暴露声明</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span></code>： 必须，无返回值</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">method_name()</span></code>： 必须，暴露方法名称</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 示例</span>
<span class="n">WASM_EXPORT</span> <span class="kt">void</span> <span class="n">init_contract</span><span class="p">()</span> <span class="p">{</span>
    
<span class="p">}</span>
</pre></div>
</div>
<p><strong>其中init_contract、upgrade方法必须有且对外暴露</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">init_contract</span></code>：创建合约会执行该方法</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">upgrade</span></code>： 升级合约会执行该方法</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 在创建本合约时, 调用一次init方法. ChainMaker不允许用户直接调用该方法.</span>
<span class="n">WASM_EXPORT</span> <span class="kt">void</span> <span class="n">init_contract</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 安装时的业务逻辑，可为空</span>
    
<span class="p">}</span>

<span class="c1">// 在升级本合约时, 对于每一个升级的版本调用一次upgrade方法. ChainMaker不允许用户直接调用该方法.</span>
<span class="n">WASM_EXPORT</span> <span class="kt">void</span> <span class="n">upgrade</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 升级时的业务逻辑，可为空</span>
    
<span class="p">}</span>
</pre></div>
</div>
<p><strong>获取SDK 接口上下文</strong></p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">Context</span><span class="o">*</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4><span class="section-number">1.1.1.4. </span>编译说明<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>在ChainMaker提供的Docker容器中中集成了编译器，可以对合约进行编译，集成的编译器是emcc 1.38.48版本，protobuf 使用3.7.1版本。用户如果手工编译需要先使用emcc 编译 protobuf ，编译之后执行emmake make即可。</p>
</div>
</div>
<div class="section" id="id6">
<h3><span class="section-number">1.1.2. </span>合约发布过程<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>请参考：<a class="reference internal" href="chainmaker-go-sdk.html"><span class="doc">《chainmaker-go-sdk》</span></a>发送创建合约请求的部分，或者<a class="reference internal" href="chainmaker-java-sdk.html"><span class="doc">《chainmaker-java-sdk》</span></a>创建合约的部分。</p>
</div>
<div class="section" id="id7">
<h3><span class="section-number">1.1.3. </span>合约调用过程<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>请参考：<a class="reference internal" href="chainmaker-go-sdk.html"><span class="doc">《chainmaker-go-sdk》</span></a>合约调用的部分，或者<a class="reference internal" href="chainmaker-java-sdk.html"><span class="doc">《chainmaker-java-sdk》</span></a>执行合约的部分。</p>
</div>
<div class="section" id="c-sdk-api">
<h3><span class="section-number">1.1.4. </span>C++ SDK API描述<a class="headerlink" href="#c-sdk-api" title="Permalink to this headline">¶</a></h3>
<p><span id="sdk-api">arg</span></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可返回属性名为 “name” 的参数的属性值。</span>
<span class="c1">// @param name: 要获取值的参数名称</span>
<span class="c1">// @param value: 获取的参数值</span>
<span class="c1">// @return: 是否成功</span>
<span class="kt">bool</span> <span class="nf">arg</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){}</span>
</pre></div>
</div>
<p>需要注意的是通过arg接口返回的参数，全都都是字符串，合约开发者有必要将其他数据类型的参数与字符串做转换，包括atoi、itoa、自定义序列化方式等。</p>
<p>get_object</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取key为&quot;key&quot;的值</span>
<span class="c1">// @param key: 获取对象的key</span>
<span class="c1">// @param value: 获取的对象值</span>
<span class="c1">// @return: 是否成功</span>
<span class="kt">bool</span> <span class="nf">get_object</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">value</span><span class="p">){}</span>
</pre></div>
</div>
<p>put_object</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 存储key为&quot;key&quot;的值</span>
<span class="c1">// @param key: 存储的对象key，注意key长度不允许超过64，且只允许大小写字母、数字、下划线、减号、小数点符号</span>
<span class="c1">// @param value: 存储的对象值install</span>
<span class="c1">// @return: 是否成功</span>
<span class="kt">bool</span> <span class="nf">put_object</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){}</span>
</pre></div>
</div>
<p>delete_object</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 删除key为&quot;key&quot;的值</span>
<span class="c1">// @param key: 删除的对象key</span>
<span class="c1">// @return: 是否成功</span>
<span class="kt">bool</span> <span class="nf">delete_object</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>emit_event</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 发送合约事件</span>
<span class="c1">// @param topic: 合约事件主题</span>
<span class="c1">// @data_amount: 合约事件数据数量(data)，data_amount的值必须要和data数量一致，最多不可大于16，最少不可小于1,不可为空</span>
<span class="c1">// @data ...: 可变参数合约事件数据，数量与data_amount一致。</span>
<span class="kt">bool</span> <span class="n">emit_event</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">topic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_amount</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">data</span><span class="p">,</span> <span class="p">...)</span>
</pre></div>
</div>
<p>success</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 返回成功的结果</span>
<span class="c1">// @param body: 成功信息</span>
<span class="kt">void</span> <span class="nf">success</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">body</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>error</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 返回失败结果</span>
<span class="c1">// @param body: 失败信息</span>
<span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">body</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>call</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 跨合约调用</span>
<span class="c1">// @param contract: 合约名称</span>
<span class="c1">// @param method: 合约方法</span>
<span class="c1">// @param args: 调用合约的参数，调用参数仅仅接受字符串类型的key、value</span>
<span class="c1">// @param response: 调用合约的响应</span>
<span class="c1">// @return: 是否成功</span>
<span class="kt">bool</span> <span class="nf">call</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">contract</span><span class="p">,</span>
                      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">method</span><span class="p">,</span>
                      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">,</span>
                      <span class="n">Response</span><span class="o">*</span> <span class="n">response</span><span class="p">){}</span>
</pre></div>
</div>
<p>log</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 输出日志事件</span>
<span class="c1">// @param body: 事件信息</span>
<span class="kt">void</span> <span class="nf">log</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">body</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="go-tinygo">
<h2><span class="section-number">1.2. </span>使用Go(TinyGo)进行智能合约开发<a class="headerlink" href="#go-tinygo" title="Permalink to this headline">¶</a></h2>
<p>读者对象：本章节主要描述使用Go进行ChainMaker合约编写的方法，主要面向于使用Go进行ChainMaker的合约开发的开发者。为了最小化wasm文件尺寸，使用的是TinyGO编译器。</p>
<div class="section" id="id8">
<h3><span class="section-number">1.2.1. </span>使用Docker镜像进行合约开发<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>ChainMaker官方已经将容器发布至GitHub</p>
<p>拉取镜像</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">pull</span> <span class="n">chainmakeroffcial</span><span class="o">/</span><span class="n">chainmaker</span><span class="o">-</span><span class="n">go</span><span class="o">-</span><span class="n">contract</span><span class="p">:</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
<p>请指定你本机的工作目录$WORK_DIR，例如C:\tmp，挂载到docker容器中以方便后续进行必要的一些文件拷贝</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker run -it --name chainmaker-go-contract -v <span class="nv">$WORK_DIR</span>:/home chainmakeroffcial/chainmaker-go-contract:1.1.0 bash
<span class="c1"># 或者先后台启动</span>
docker run -d  --name chainmaker-go-contract -v <span class="nv">$WORK_DIR</span>:/home chainmakeroffcial/chainmaker-go-contract:1.1.0 bash -c <span class="s2">&quot;while true; do echo hello world; sleep 5;done&quot;</span>
<span class="c1"># 再进入容器</span>
docker <span class="nb">exec</span> -it chainmaker-go-contract /bin/sh
</pre></div>
</div>
<p>编译合约</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /home/
tar xvf /data/contract_go_template.tar.gz
<span class="nb">cd</span> contract_tinygo
sh build.sh
</pre></div>
</div>
<p>生成合约的字节码文件在</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">contract_go</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">wasm</span>
</pre></div>
</div>
<p>通过本地模拟环境运行合约(首次编译运行合约可能需要10秒左右，下面以存证作为示例)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># gasm main.wasm test_function test_key 20210304 file_hash 12345678 file_name a.txt</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">03</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mf">46.307</span>      <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">Vm</span><span class="p">]</span>    <span class="n">waci</span><span class="o">/</span><span class="n">waci</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">34</span> <span class="n">waci</span> <span class="n">log</span><span class="o">&gt;&gt;</span> <span class="p">[</span><span class="n">test</span><span class="o">-</span><span class="n">TxId</span><span class="p">]</span> <span class="n">get</span> <span class="n">val</span><span class="p">:{</span><span class="s2">&quot;txId&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="s2">&quot;20210304&quot;</span><span class="p">,</span><span class="s2">&quot;fileHash&quot;</span><span class="p">:</span><span class="s2">&quot;12345678&quot;</span><span class="p">,</span><span class="s2">&quot;fileName&quot;</span><span class="p">:</span><span class="s2">&quot;a.txt&quot;</span><span class="p">}</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">03</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mf">46.329</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">Vm</span><span class="p">]</span>    <span class="n">gasm</span><span class="o">/</span><span class="n">runtime</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">190</span>     <span class="n">invoke</span> <span class="n">gasm</span> <span class="n">success</span><span class="p">,</span> <span class="n">tx</span> <span class="nb">id</span><span class="p">:</span><span class="n">test</span><span class="o">-</span><span class="n">TxId</span><span class="p">,</span> <span class="n">gas</span> <span class="n">cost</span> <span class="mi">18012689</span><span class="p">,[</span><span class="n">IGNORE</span><span class="p">:</span> <span class="n">ret</span> <span class="p">[],</span> <span class="n">retTypes</span> <span class="p">[]]</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">03</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mf">46.331</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span>  <span class="p">[</span><span class="n">Vm</span><span class="p">]</span> <span class="nd">@chain01</span>   <span class="n">main</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">27</span> <span class="n">contractResult</span> <span class="p">:</span><span class="n">result</span><span class="p">:</span><span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">txId</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">time</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">20210304</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">fileHash</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">12345678</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">fileName</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">a.txt</span><span class="se">\&quot;</span><span class="s2">}&quot;</span> <span class="n">gas_used</span><span class="p">:</span><span class="mi">18012689</span>
</pre></div>
</div>
<p>其中该处的合约方法定义为：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>


<span class="c1">// 安装合约时会执行此方法，必须</span>
<span class="c1">//export init_contract</span>
<span class="kd">func</span> <span class="nx">initContract</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="c1">// 升级合约时会执行此方法，必须</span>
<span class="c1">//export upgrade</span>
<span class="kd">func</span> <span class="nx">upgrade</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="c1">//export save</span>
<span class="kd">func</span> <span class="nx">save</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// 获取参数</span>
	<span class="nx">txId</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">GetTxId</span><span class="p">()</span>
	<span class="nx">time</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">Arg</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">)</span>
	<span class="nx">fileHash</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">Arg</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">)</span>
	<span class="nx">fileName</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">Arg</span><span class="p">(</span><span class="s">&quot;file_name&quot;</span><span class="p">)</span>

	<span class="c1">// 组装</span>
	<span class="nx">stone</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
	<span class="nx">stone</span><span class="p">[</span><span class="s">&quot;txId&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">txId</span>
	<span class="nx">stone</span><span class="p">[</span><span class="s">&quot;time&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">time</span>
	<span class="nx">stone</span><span class="p">[</span><span class="s">&quot;fileHash&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">fileHash</span>
	<span class="nx">stone</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">fileName</span>
    <span class="c1">//发送事件</span>
    <span class="c1">//向topic:&quot;topic_vx&quot;发送2个event数据，file_hash,time</span>
	<span class="nx">EmitEvent</span><span class="p">(</span><span class="s">&quot;topic_vx&quot;</span><span class="p">,</span> <span class="nx">fileHash</span><span class="p">,</span> <span class="nx">time</span><span class="p">)</span>
  
	<span class="c1">// 序列化为json bytes</span>
	<span class="nx">items</span> <span class="o">:=</span> <span class="nx">ParamsMapToEasyCodecItem</span><span class="p">(</span><span class="nx">stone</span><span class="p">)</span>
	<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="nx">EasyCodecItemToJsonStr</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span>

	<span class="c1">// 存储数据</span>
	<span class="nx">PutState</span><span class="p">(</span><span class="s">&quot;fact&quot;</span><span class="p">,</span> <span class="nx">fileHash</span><span class="p">,</span> <span class="nx">jsonStr</span><span class="p">)</span>
	<span class="c1">// 返回结果</span>
	<span class="nx">SuccessResult</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//export find_by_file_hash</span>
<span class="kd">func</span> <span class="nx">findByFileHash</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// 获取参数</span>
	<span class="nx">fileHash</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">Arg</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">)</span>
	<span class="c1">// 查询</span>
	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">resultCode</span> <span class="o">:=</span> <span class="nx">GetStateByte</span><span class="p">(</span><span class="s">&quot;fact&quot;</span><span class="p">,</span> <span class="nx">fileHash</span><span class="p">);</span> <span class="nx">resultCode</span> <span class="o">!=</span> <span class="nx">SUCCESS</span> <span class="p">{</span>
		<span class="c1">// 返回结果</span>
		<span class="nx">ErrorResult</span><span class="p">(</span><span class="s">&quot;failed to call get_state, only 64 letters and numbers are allowed. got key:&quot;</span> <span class="o">+</span> <span class="s">&quot;fact&quot;</span> <span class="o">+</span> <span class="s">&quot;, field:&quot;</span> <span class="o">+</span> <span class="nx">fileHash</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c1">// 记录日志</span>
		<span class="nx">LogMessage</span><span class="p">(</span><span class="s">&quot;get val:&quot;</span> <span class="o">+</span> <span class="nb">string</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span>
		<span class="c1">// 返回结果</span>
		<span class="nx">SuccessResultByte</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id9">
<h4><span class="section-number">1.2.1.1. </span>示例代码说明<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p><strong>存证合约示例</strong>，实现功能</p>
<p>1、存储文件哈希和文件名称和该交易的ID。</p>
<p>2、通过文件哈希查询该条记录</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>


<span class="c1">// 安装合约时会执行此方法，必须</span>
<span class="c1">//export init_contract</span>
<span class="kd">func</span> <span class="nx">initContract</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="c1">// 升级合约时会执行此方法，必须</span>
<span class="c1">//export upgrade</span>
<span class="kd">func</span> <span class="nx">upgrade</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="c1">//export save</span>
<span class="kd">func</span> <span class="nx">save</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// 获取参数</span>
	<span class="nx">txId</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">GetTxId</span><span class="p">()</span>
	<span class="nx">time</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">Arg</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">)</span>
	<span class="nx">fileHash</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">Arg</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">)</span>
	<span class="nx">fileName</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">Arg</span><span class="p">(</span><span class="s">&quot;file_name&quot;</span><span class="p">)</span>

	<span class="c1">// 组装</span>
	<span class="nx">stone</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
	<span class="nx">stone</span><span class="p">[</span><span class="s">&quot;txId&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">txId</span>
	<span class="nx">stone</span><span class="p">[</span><span class="s">&quot;time&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">time</span>
	<span class="nx">stone</span><span class="p">[</span><span class="s">&quot;fileHash&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">fileHash</span>
	<span class="nx">stone</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">fileName</span>

    <span class="c1">//发送事件</span>
    <span class="c1">//向topic:&quot;topic_vx&quot;发送2个event数据，file_hash,time</span>
	<span class="nx">EmitEvent</span><span class="p">(</span><span class="s">&quot;topic_vx&quot;</span><span class="p">,</span> <span class="nx">fileHash</span><span class="p">,</span> <span class="nx">time</span><span class="p">)</span>
  
	<span class="c1">// 序列化为json bytes</span>
	<span class="nx">items</span> <span class="o">:=</span> <span class="nx">ParamsMapToEasyCodecItem</span><span class="p">(</span><span class="nx">stone</span><span class="p">)</span>
	<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="nx">EasyCodecItemToJsonStr</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span>

	<span class="c1">// 存储数据</span>
	<span class="nx">PutState</span><span class="p">(</span><span class="s">&quot;fact&quot;</span><span class="p">,</span> <span class="nx">fileHash</span><span class="p">,</span> <span class="nx">jsonStr</span><span class="p">)</span>
	<span class="c1">// 返回结果</span>
	<span class="nx">SuccessResult</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//export find_by_file_hash</span>
<span class="kd">func</span> <span class="nx">findByFileHash</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// 获取参数</span>
	<span class="nx">fileHash</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">Arg</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">)</span>
	<span class="c1">// 查询</span>
	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">resultCode</span> <span class="o">:=</span> <span class="nx">GetStateByte</span><span class="p">(</span><span class="s">&quot;fact&quot;</span><span class="p">,</span> <span class="nx">fileHash</span><span class="p">);</span> <span class="nx">resultCode</span> <span class="o">!=</span> <span class="nx">SUCCESS</span> <span class="p">{</span>
		<span class="c1">// 返回结果</span>
		<span class="nx">ErrorResult</span><span class="p">(</span><span class="s">&quot;failed to call get_state, only 64 letters and numbers are allowed. got key:&quot;</span> <span class="o">+</span> <span class="s">&quot;fact&quot;</span> <span class="o">+</span> <span class="s">&quot;, field:&quot;</span> <span class="o">+</span> <span class="nx">fileHash</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c1">// 记录日志</span>
		<span class="nx">LogMessage</span><span class="p">(</span><span class="s">&quot;get val:&quot;</span> <span class="o">+</span> <span class="nb">string</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span>
		<span class="c1">// 返回结果</span>
		<span class="nx">SuccessResultByte</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h4><span class="section-number">1.2.1.2. </span>代码编写规则<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p><strong>代码入口</strong></p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// sdk代码中，有且仅有一个main()方法</span>
	<span class="c1">// 空，不做任何事。仅用于对tinygo编译支持</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>对链暴露方法写法为：</strong></p>
<ul class="simple">
<li><p>//export upgrade</p></li>
<li><p>func  method_name(): 不可带参数，无返回值</p></li>
</ul>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">//export init_contract 表明对外暴露方法名称</span>
<span class="n">func</span><span class="w"> </span><span class="n">init_contract</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>其中init_contract、upgrade方法必须有且对外暴露</strong></p>
<ul class="simple">
<li><p>init_contract：创建合约会执行该方法</p></li>
<li><p>upgrade： 升级合约会执行该方法</p></li>
</ul>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 安装合约时会执行此方法，必须。ChainMaker不允许用户直接调用该方法。</span>
<span class="c1">//export init_contract</span>
<span class="n">func</span><span class="w"> </span><span class="n">init_contract</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
<span class="c1">// 升级合约时会执行此方法，必须。ChainMaker不允许用户直接调用该方法。</span>
<span class="c1">//export upgrade</span>
<span class="n">func</span><span class="w"> </span><span class="n">upgrade</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h4><span class="section-number">1.2.1.3. </span>编译说明<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>在ChainMaker IDE中集成了编译器，可以对合约进行编译。集成的编译器是 TinyGo。用户如果手工编译，需要将 SDK 和用户编写的智能合约放入同一个文件夹，并在此文件夹的当前路径执行如下编译命令：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tinygo build -no-debug -opt<span class="o">=</span>s -o name.wasm -target wasm
</pre></div>
</div>
<p>命令中 “name.wasm” 为生成的WASM 字节码的文件名，由用户自行指定。</p>
</div>
</div>
<div class="section" id="id12">
<h3><span class="section-number">1.2.2. </span>合约发布过程<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>请参考：<a class="reference internal" href="chainmaker-go-sdk.html"><span class="doc">《chainmaker-go-sdk》</span></a>发送创建合约请求的部分，或者<a class="reference internal" href="chainmaker-java-sdk.html"><span class="doc">《chainmaker-java-sdk》</span></a>创建合约的部分。</p>
</div>
<div class="section" id="id13">
<h3><span class="section-number">1.2.3. </span>合约调用过程<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>请参考：<a class="reference internal" href="chainmaker-go-sdk.html"><span class="doc">《chainmaker-go-sdk》</span></a>合约调用的部分，或者<a class="reference internal" href="chainmaker-java-sdk.html"><span class="doc">《chainmaker-java-sdk》</span></a>执行合约的部分。</p>
</div>
<div class="section" id="go-sdk-api">
<h3><span class="section-number">1.2.4. </span>Go SDK API描述<a class="headerlink" href="#go-sdk-api" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id14">
<h4><span class="section-number">1.2.4.1. </span>用户与链交互接口<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">SimContextCommon</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// common</span>
	<span class="nx">Arg</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">Args</span><span class="p">()</span> <span class="p">[]</span><span class="o">*</span><span class="nx">EasyCodecItem</span>
	<span class="nx">Log</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span>
	<span class="nx">SuccessResult</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span>
	<span class="nx">SuccessResultByte</span><span class="p">(</span><span class="nx">msg</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
	<span class="nx">ErrorResult</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span>
	<span class="nx">CallContract</span><span class="p">(</span><span class="nx">contractName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">param</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetCreatorOrgId</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetCreatorRole</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetCreatorPk</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetSenderOrgId</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetSenderRole</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetSenderPk</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetBlockHeight</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetTxId</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
  <span class="nx">EmitEvent</span><span class="p">(</span><span class="nx">topic</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">data</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">SimContext</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">SimContextCommon</span>
	<span class="c1">// kv method</span>
	<span class="nx">GetState</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">field</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetStateByte</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">field</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">GetStateFromKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span>
	<span class="nx">PutState</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">field</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span>
	<span class="nx">PutStateByte</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">field</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="nx">ResultCode</span>
	<span class="nx">PutStateFromKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span>
	<span class="nx">PutStateFromKeyByte</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="nx">ResultCode</span>
	<span class="nx">DeleteState</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">field</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span>
	<span class="nx">DeleteStateFromKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span>
<span class="p">}</span>
</pre></div>
</div>
<p>GetState</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约账户信息。该接口可从链上获取类别 “key” 下属性名为 “field” 的状态信息。</span>
<span class="c1">// @param key: 需要查询的key值</span>
<span class="c1">// @param field: 需要查询的key值下属性名为field</span>
<span class="c1">// @return1: 查询到的value值</span>
<span class="c1">// @return2: 0: success, 1: failed</span>
<span class="kd">func</span> <span class="nx">GetState</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">field</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span> <span class="p">{}</span> 
</pre></div>
</div>
<p>GetStateFromKey</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约账户信息。该接口可以从链上获取类别为key的状态信息</span>
<span class="c1">// @param key: 需要查询的key值</span>
<span class="c1">// @return1: 查询到的值</span>
<span class="c1">// @return: 0: success, 1: failed</span>
<span class="kd">func</span> <span class="nx">GetStateFromKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>PutState</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 写入合约账户信息。该接口可把类别 “key” 下属性名为 “filed” 的状态更新到链上。更新成功返回0，失败则返回1。</span>
<span class="c1">// @param key: 需要存储的key值，注意key长度不允许超过64，且只允许大小写字母、数字、下划线、减号、小数点符号</span>
<span class="c1">// @param field: 需要存储的key值下属性名为field，注意field长度不允许超过64，且只允许大小写字母、数字、下划线、减号、小数点符号</span>
<span class="c1">// @param value: 需要存储的value值，注意存储的value字节长度不能超过200</span>
<span class="c1">// @return: 0: success, 1: failed</span>
<span class="kd">func</span> <span class="nx">PutState</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">field</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span> <span class="p">{}</span>
</pre></div>
</div>
<p>PutStateFromKey</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 写入合约账户信息。</span>
<span class="c1">// @param key: 需要存储的key值</span>
<span class="c1">// @param value: 需要存储的value值</span>
<span class="c1">// @return: 0: success, 1: failed</span>
<span class="kd">func</span> <span class="nx">PutStateFromKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span>
</pre></div>
</div>
<p>DeleteState</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 删除合约账户信息。该接口可把类别 “key” 下属性名为 “name” 的状态从链上删除。</span>
<span class="c1">// @param key: 需要删除的key值</span>
<span class="c1">// @param field: 需要删除的key值下属性名为field</span>
<span class="c1">// @return: 0: success, 1: failed</span>
<span class="kd">func</span> <span class="nx">DeleteState</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">field</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span> <span class="p">{}</span>
</pre></div>
</div>
<p>CallContract</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 跨合约调用。</span>
<span class="c1">// @param contractName 合约名称</span>
<span class="c1">// @param method 合约方法</span>
<span class="c1">// @param param 参数</span>
<span class="c1">// @return 0:合约返回结果， 1：合约执行结果</span>
<span class="kd">func</span> <span class="nx">CallContract</span><span class="p">(</span><span class="nx">contractName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">param</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">ResultCode</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Args</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口调用 getArgsMap() 接口，把 json 格式的数据反序列化，并将解析出的数据返还给用户。</span>
<span class="c1">// @return: 参数map</span>
<span class="kd">func</span> <span class="nx">Args</span><span class="p">()</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="p">{}</span>  
</pre></div>
</div>
<p>Arg</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可返回属性名为 “key” 的参数的属性值。</span>
<span class="c1">// @param key: 获取的参数名</span>
<span class="c1">// @return: 获取的参数值</span>
<span class="kd">func</span> <span class="nx">Arg</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{}</span>  
</pre></div>
</div>
<p>SuccessResult</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可记录用户操作成功的信息，并将操作结果记录到链上。</span>
<span class="c1">// @param msg: 成功信息</span>
<span class="kd">func</span> <span class="nx">SuccessResult</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{}</span>  
</pre></div>
</div>
<p>ErrorResult</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可记录用户操作失败的信息，并将操作结果记录到链上。</span>
<span class="c1">// @param msg: 失败信息</span>
<span class="kd">func</span> <span class="nx">ErrorResult</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>LogMessage</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可记录事件日志。</span>
<span class="c1">// @param msg: 事件信息</span>
<span class="kd">func</span> <span class="nx">LogMessage</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>GetCreatorOrgId</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约创建者所属组织ID</span>
<span class="c1">// @return: 合约创建者的组织ID</span>
<span class="kd">func</span> <span class="nx">GetCreatorOrgId</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{}</span>  
</pre></div>
</div>
<p>GetCreatorRole</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约创建者角色</span>
<span class="c1">// @return: 合约创建者的角色</span>
<span class="kd">func</span> <span class="nx">GetCreatorRole</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{}</span>  
</pre></div>
</div>
<p>GetCreatorPk</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约创建者公钥</span>
<span class="c1">// @return: 合约创建者的公钥</span>
<span class="kd">func</span> <span class="nx">GetCreatorPk</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{}</span> 
</pre></div>
</div>
<p>GetSenderOrgId</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取交易发起者所属组织ID</span>
<span class="c1">// @return: 交易发起者的组织ID</span>
<span class="kd">func</span> <span class="nx">GetSenderOrgId</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{}</span>  
</pre></div>
</div>
<p>GetSenderRole</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取交易发起者角色</span>
<span class="c1">// @return: 交易发起者角色</span>
<span class="kd">func</span> <span class="nx">GetSenderRole</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{}</span> 
</pre></div>
</div>
<p>GetSenderPk()</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取交易发起者公钥</span>
<span class="c1">// @return 交易发起者的公钥</span>
<span class="kd">func</span> <span class="nx">GetSenderPk</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{}</span>  
</pre></div>
</div>
<p>GetBlockHeight</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取当前区块高度</span>
<span class="c1">// @return: 当前块高度</span>
<span class="kd">func</span> <span class="nx">GetBlockHeight</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{}</span> 
</pre></div>
</div>
<p>GetTxId</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取交易ID</span>
<span class="c1">// @return 交易ID</span>
<span class="kd">func</span> <span class="nx">GetTxId</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{}</span>
</pre></div>
</div>
<p>EmitEvent</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 发送合约事件</span>
<span class="c1">// @param topic: 合约事件主题</span>
<span class="c1">// @data ...: 可变参数,合约事件数据，参数数量不可大于16，不可小于1。</span>
<span class="kd">func</span> <span class="nx">EmitEvent</span><span class="p">(</span><span class="nx">topic</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">data</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="nx">ResultCode</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="rust">
<h2><span class="section-number">1.3. </span>使用Rust进行智能合约开发<a class="headerlink" href="#rust" title="Permalink to this headline">¶</a></h2>
<p>读者对象：本章节主要描述使用Rust进行ChainMaker合约编写的方法，主要面向于使用Rust进行ChainMaker的合约开发的开发者。</p>
<div class="section" id="id15">
<h3><span class="section-number">1.3.1. </span>使用Docker镜像进行合约开发<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>ChainMaker官方已经将容器发布至GitHub</p>
<p>拉取镜像</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker pull chainmakeroffcial/chainmaker-rust-contract:1.1.0
</pre></div>
</div>
<p>请指定你本机的工作目录$WORK_DIR，例如C:\tmp，挂载到docker容器中以方便后续进行必要的一些文件拷贝</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker run -it --name chainmaker-rust-contract -v <span class="nv">$WORK_DIR</span>:/home chainmakeroffcial/chainmaker-rust-contract:1.1.0 bash
<span class="c1"># 或者先后台启动</span>
docker run -d  --name chainmaker-rust-contract -v <span class="nv">$WORK_DIR</span>:/home chainmakeroffcial/chainmaker-rust-contract:1.1.0 bash -c <span class="s2">&quot;while true; do echo hello world; sleep 5;done&quot;</span>
<span class="c1"># 再进入容器</span>
docker <span class="nb">exec</span> -it chainmaker-rust-contract /bin/sh
</pre></div>
</div>
<p>编译合约</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /home/
tar xvf /data/contract_rust_template.tar.gz
<span class="nb">cd</span> contract_rust
wasm-pack build
</pre></div>
</div>
<p>生成合约的字节码文件在</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">contract_rust</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">unknown</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">chainmaker_contract</span><span class="o">.</span><span class="n">wasm</span>
</pre></div>
</div>
<div class="section" id="id16">
<h4><span class="section-number">1.3.1.1. </span>框架描述<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>解压缩contract_rust_template.tar.gz后，文件描述如下：</p>
<ul class="simple">
<li><p>Cargo.toml： 工程配置，参考：https://rustwasm.github.io/wasm-pack/book/cargo-toml-configuration.html</p></li>
<li><p>src： 源码目录</p>
<ul>
<li><p>lib.rs： SDK入口</p></li>
<li><p>sim_context.rs：主要SDK工具类，详情接口见下方<a class="reference external" href="#sdk-api">Rust SDK API</a>描述</p></li>
<li><p>vec_box.rs： 内存管理工具类</p></li>
<li><p>easycodec.rs:  序列化工具类</p></li>
<li><p><a class="reference external" href="#fact">main_fact.rs</a>：存证示例代码</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id17">
<h4><span class="section-number">1.3.1.2. </span>示例代码说明<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p><strong>存证合约示例：main_fact.rs <span id="fact"></span></strong> 实现功能</p>
<p>1、存储文件哈希和文件名称和时间。</p>
<p>2、通过文件哈希查询该条记录</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">easycodec</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">sim_context</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">sim_context</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="c1">// 安装合约时会执行此方法，必须</span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">init_contract</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 安装时的业务逻辑，内容可为空</span>
<span class="w">    </span><span class="n">sim_context</span>::<span class="n">log</span><span class="p">(</span><span class="s">&quot;init_contract&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// 升级合约时会执行此方法，必须</span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">upgrade</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 升级时的业务逻辑，内容可为空</span>
<span class="w">    </span><span class="n">sim_context</span>::<span class="n">log</span><span class="p">(</span><span class="s">&quot;upgrade&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">sim_context</span>::<span class="n">get_kv_sim_context</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="s">&quot;upgrade success&quot;</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// 存证对象</span>
<span class="k">struct</span> <span class="nc">Fact</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">file_hash</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">file_name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">time</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Fact</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">to_easy_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">EasyCodec</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EasyCodec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">ec</span><span class="p">.</span><span class="n">add_string</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">file_hash</span><span class="p">.</span><span class="n">as_str</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">ec</span><span class="p">.</span><span class="n">add_string</span><span class="p">(</span><span class="s">&quot;file_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">file_name</span><span class="p">.</span><span class="n">as_str</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">ec</span><span class="p">.</span><span class="n">add_i32</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">time</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ec</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">unmarshal</span><span class="p">(</span><span class="n">data</span>: <span class="kp">&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fact</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EasyCodec</span>::<span class="n">new_with_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Fact</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">file_hash</span>: <span class="nc">ec</span><span class="p">.</span><span class="n">get_string</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">file_name</span>: <span class="nc">ec</span><span class="p">.</span><span class="n">get_string</span><span class="p">(</span><span class="s">&quot;file_name&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">time</span>: <span class="nc">ec</span><span class="p">.</span><span class="n">get_i32</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// save 保存存证数据</span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">save</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 获取上下文</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">sim_context</span>::<span class="n">get_kv_sim_context</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 获取传入参数</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">file_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">arg_default_blank</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">arg_default_blank</span><span class="p">(</span><span class="s">&quot;file_name&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">time_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">arg_default_blank</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 构造结构体</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_str</span><span class="p">.</span><span class="n">parse</span>::<span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">tmp</span><span class="p">.</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;time is {:?} not int32 number.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time_str</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">time</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fact</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">file_hash</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">file_name</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">time</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 发送合约事件</span>
<span class="w">    </span><span class="c1">// 向topic:&quot;topic_vx&quot;发送2个event数据，file_hash,file_name</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">arr</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">arr</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">fact</span><span class="p">.</span><span class="n">file_hash</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">arr</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">fact</span><span class="p">.</span><span class="n">file_name</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">emit_event</span><span class="p">(</span><span class="s">&quot;topic_vx&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arr</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 序列化后存储</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fact</span><span class="p">.</span><span class="n">to_easy_codec</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">put_state</span><span class="p">(</span><span class="s">&quot;fact_json&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fact</span><span class="p">.</span><span class="n">file_hash</span><span class="p">.</span><span class="n">as_str</span><span class="p">(),</span><span class="w"> </span><span class="n">ec</span><span class="p">.</span><span class="n">to_json</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">put_state</span><span class="p">(</span><span class="s">&quot;fact_ec&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fact</span><span class="p">.</span><span class="n">file_hash</span><span class="p">.</span><span class="n">as_str</span><span class="p">(),</span><span class="w"> </span><span class="n">ec</span><span class="p">.</span><span class="n">marshal</span><span class="p">().</span><span class="n">as_slice</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// find_by_file_hash 根据file_hash查询存证数据</span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">find_by_file_hash</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 获取上下文</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">sim_context</span>::<span class="n">get_kv_sim_context</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 获取传入参数</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">file_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">arg_default_blank</span><span class="p">(</span><span class="s">&quot;file_hash&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 校验参数</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">file_hash</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;file_hash is null&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 查询</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">get_state</span><span class="p">(</span><span class="s">&quot;fact_json&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">file_hash</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 校验返回结果</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;get_state fail&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;get_state fail&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fact_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">fact_vec</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;None&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 转换为字符串</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fact_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="kt">str</span>::<span class="n">from_utf8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fact_vec</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 打印日志</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;get fact_json data: &quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">fact_str</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 返回查询结果</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="n">fact_str</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 查询2</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">get_state</span><span class="p">(</span><span class="s">&quot;fact_ec&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">file_hash</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fact</span>::<span class="n">unmarshal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fact</span><span class="p">.</span><span class="n">to_easy_codec</span><span class="p">().</span><span class="n">to_json</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id18">
<h4><span class="section-number">1.3.1.3. </span>代码编写规则<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p><strong>对链暴露方法写法为：</strong></p>
<ul class="simple">
<li><p>#[no_mangle] 表示方法名编译后是固定的，不写会生成 _ZN4rustfn1_34544tert54grt5 类似的混淆名</p></li>
<li><p>pub extern “C”</p></li>
<li><p>method_name(): 不可带参数，无返回值</p></li>
</ul>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[no_mangle]</span><span class="c1">// no_mangle注解，表明对外暴露方法名称不可变</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">init_contract</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// pub extern &quot;C&quot; 集成C</span>
<span class="w">    </span><span class="c1">// do something </span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>其中init_contract、upgrade方法必须有且对外暴露</strong></p>
<ul class="simple">
<li><p>init_contract：创建合约会执行该方法</p></li>
<li><p>upgrade： 升级合约会执行该方法</p></li>
</ul>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 安装合约时会执行此方法。ChainMaker不允许用户直接调用该方法。</span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">init_contract</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// dosome thing</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// 升级合约时会执行此方法。ChainMaker不允许用户直接调用该方法。</span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">upgrade</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>获取与链交互的上下文sim_context</strong></p>
<p>1、在<code class="docutils literal notranslate"><span class="pre">lib.rs</span></code>中引入sim_context</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">sim_context</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>2、在使用时引入sim_context</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">sim_context</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">method_name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 获取上下文</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">sim_context</span>::<span class="n">get_sim_context</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id19">
<h4><span class="section-number">1.3.1.4. </span>编译说明<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>在ChainMaker IDE中集成了编译器，可以对合约进行编译，集成的rust编译器是<code class="docutils literal notranslate"><span class="pre">rustc:</span> <span class="pre">1.48.0</span></code>，wasm编译器是<code class="docutils literal notranslate"><span class="pre">wasm-pack:</span> <span class="pre">0.9.1</span></code>， 采用默认cargo管理包，版本为<code class="docutils literal notranslate"><span class="pre">cargo:</span> <span class="pre">1.49.0</span></code>， 默认提供<a class="reference external" href="https://crates.io/crates/json">json: 0.12.4</a>库，合约支持在线其他轻量级序列化方式。用户如果手工编译需在项目根目录执行命令： <code class="docutils literal notranslate"><span class="pre">wasm-pack</span> <span class="pre">build</span> <span class="pre">--release</span></code>，会在target中生成wasm文件。</p>
</div>
</div>
<div class="section" id="id20">
<h3><span class="section-number">1.3.2. </span>合约发布过程<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>请参考：<a class="reference internal" href="chainmaker-go-sdk.html"><span class="doc">《chainmaker-go-sdk》</span></a>发送创建合约请求的部分，或者<a class="reference internal" href="chainmaker-java-sdk.html"><span class="doc">《chainmaker-java-sdk》</span></a>创建合约的部分。</p>
</div>
<div class="section" id="id21">
<h3><span class="section-number">1.3.3. </span>合约调用过程<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p>请参考：<a class="reference internal" href="chainmaker-go-sdk.html"><span class="doc">《chainmaker-go-sdk》</span></a>合约调用的部分，或者<a class="reference internal" href="chainmaker-java-sdk.html"><span class="doc">《chainmaker-java-sdk》</span></a>执行合约的部分。</p>
</div>
<div class="section" id="rust-sdk-api-span-id-api-span">
<h3><span class="section-number">1.3.4. </span>Rust SDK API描述 <span id="api"></span><a class="headerlink" href="#rust-sdk-api-span-id-api-span" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id22">
<h4><span class="section-number">1.3.4.1. </span>内置链交互接口<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>用于链与SDK数据交互，用户无需关心。</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 申请size大小内存，返回该内存的首地址</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">size</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{}</span><span class="w"></span>
<span class="c1">// 释放某地址</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">deallocate</span><span class="p">(</span><span class="n">pointer</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_void</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="c1">// 获取SDK运行时环境</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">runtime_type</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id23">
<h4><span class="section-number">1.3.4.2. </span>用户与链交互接口<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">KVSimContext</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// common method</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">call_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">contract_name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">method</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">param</span>: <span class="nc">EasyCodec</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">result_code</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">ok</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">error</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">body</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">log</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">arg</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">arg_default_blank</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">args</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">EasyCodec</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_creator_org_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_creator_pub_key</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_creator_role</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_sender_org_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_sender_pub_key</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_sender_role</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_block_height</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_tx_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">emit_event</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">topic</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// KV method</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">field</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">result_code</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_state_from_key</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">result_code</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">put_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">field</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">put_state_from_key</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">delete_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">field</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">delete_state_from_key</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>get_state</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约账户信息。该接口可从链上获取类别 “key” 下属性名为 “field” 的状态信息。</span>
<span class="c1">// @param key: 需要查询的key值</span>
<span class="c1">// @param field: 需要查询的key值下属性名为field</span>
<span class="c1">// @return1: 查询到的value值</span>
<span class="c1">// @return2: 0: success, 1: failed</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_state</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">field</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">result_code</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>get_state_from_key</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约账户信息。该接口可以从链上获取类别为key的状态信息</span>
<span class="c1">// @param key: 需要查询的key值</span>
<span class="c1">// @return1: 查询到的值</span>
<span class="c1">// @return2:  0: success, 1: failed</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_state_from_key</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">result_code</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>put_state</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 写入合约账户信息。该接口可把类别 “key” 下属性名为 “filed” 的状态更新到链上。更新成功返回0，失败则返回1。</span>
<span class="c1">// @param key: 需要存储的key值</span>
<span class="c1">// @param field: 需要存储的key值下属性名为field</span>
<span class="c1">// @param value: 需要存储的value值</span>
<span class="c1">// @return: 0: success, 1: failed</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">put_state</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">field</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>put_state_from_key</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 写入合约账户信息。</span>
<span class="c1">// @param key: 需要存储的key值</span>
<span class="c1">// @param value: 需要存储的value值</span>
<span class="c1">// @return: 0: success, 1: failed</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">put_state_from_key</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>delete_state</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 删除合约账户信息。该接口可把类别 “key” 下属性名为 “name” 的状态从链上删除。</span>
<span class="c1">// @param key: 需要删除的key值</span>
<span class="c1">// @param field: 需要删除的key值下属性名为field</span>
<span class="c1">// @return: 0: success, 1: failed</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">delete_state</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">field</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>delete_state_from_key</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 删除合约账户信息。该接口可把类别 “key” 下属性名为 “name” 的状态从链上删除。</span>
<span class="c1">// @param key: 需要删除的key值</span>
<span class="c1">// @return: 0: success, 1: failed</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">delete_state_from_key</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>call_contract</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 跨合约调用</span>
<span class="c1">// @param contract_name: 合约名称</span>
<span class="c1">// @param method: 合约方法</span>
<span class="c1">// @param EasyCodec: 合约参数</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">contract_name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">method</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">param</span>: <span class="nc">EasyCodec</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">result_code</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>args</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// @return: EasyCodec</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">args</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">EasyCodec</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>arg</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可返回属性名为 “key” 的参数的属性值。</span>
<span class="c1">// @param key: 获取的参数名</span>
<span class="c1">// @return: 获取的参数值 或 错误信息。当未传该key的值时，报错param not found</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">arg</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>arg_default_blank</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可返回属性名为 “key” 的参数的属性值。</span>
<span class="c1">// @param key: 获取的参数名</span>
<span class="c1">// @return: 获取的参数值。当未传该key的值时，返回空字符串</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">arg_default_blank</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>ok</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可记录用户操作成功的信息，并将操作结果记录到链上。</span>
<span class="c1">// @param body: 成功返回的信息</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">ok</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>error</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可记录用户操作失败的信息，并将操作结果记录到链上。</span>
<span class="c1">// @param body: 失败信息</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">error</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">body</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</pre></div>
</div>
<p>log</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 该接口可记录事件日志。</span>
<span class="c1">// @param msg: 事件信息</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</pre></div>
</div>
<p>get_creator_org_id</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约创建者所属组织ID</span>
<span class="c1">// @return: 合约创建者的组织ID</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_creator_org_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>get_creator_role</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约创建者角色</span>
<span class="c1">// @return: 合约创建者的角色</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_creator_role</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{}</span><span class="w">  </span>
</pre></div>
</div>
<p>get_creator_pub_key</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取合约创建者公钥</span>
<span class="c1">// @return: 合约创建者的公钥的SKI</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_creator_pub_key</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{}</span><span class="w"> </span>
</pre></div>
</div>
<p>get_sender_org_id</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取交易发起者所属组织ID</span>
<span class="c1">// @return: 交易发起者的组织ID</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_sender_org_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>get_sender_role</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取交易发起者角色</span>
<span class="c1">// @return: 交易发起者角色</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_sender_role</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{}</span><span class="w">  </span>
</pre></div>
</div>
<p>get_sender_pub_key()</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取交易发起者公钥</span>
<span class="c1">// @return 交易发起者的公钥的SKI</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_sender_pub_key</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{}</span><span class="w"> </span>
</pre></div>
</div>
<p>get_block_height</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取当前区块高度</span>
<span class="c1">// @return: 当前块高度</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_block_height</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>get_tx_id</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 获取交易ID</span>
<span class="c1">// @return 交易ID</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_tx_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>emit_event</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// 发送合约事件</span>
<span class="c1">// @param topic: 合约事件主题</span>
<span class="c1">// @data: 合约事件数据，vertor中事件数据个数不可大于16，不可小于1</span>
<span class="k">fn</span> <span class="nf">emit_event</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">topic</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">result_code</span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id24">
<h3><span class="section-number">1.3.5. </span>约束条件和已知问题<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>在安装<strong>CPP</strong>智能合约时，要求共识节点、非共识节点必须安装GCC。</p></li>
<li><p><strong>TinyGo</strong>对wasm的支持不太完善，对内存逃逸分析、GC等方面有不足之处，比较容易造成栈溢出。在开发合约时，应尽可能减少循环、内存申请等业务逻辑，使变量的栈内存地址在64K以内。</p></li>
<li><p><strong>TinyGo</strong>对导入的包支持有限，请参考：https://tinygo.org/lang-support/stdlib/ 对列表中显示已支持的包，实际测试发现支持的并不完整，会发生一些错误，需要在实际开发过程中进行测试检验</p></li>
<li><p><strong>TinyGo</strong>引擎不支持<code class="docutils literal notranslate"><span class="pre">fmt</span></code>包</p></li>
</ul>
</div>
</div>
<div class="section" id="solidity">
<h2><span class="section-number">1.4. </span>使用Solidity进行智能合约开发<a class="headerlink" href="#solidity" title="Permalink to this headline">¶</a></h2>
<p>读者对象：本章节主要描述使用Solidity进行ChainMaker合约编写的方法，主要面向于使用Solidity进行ChainMaker的合约开发的开发者。</p>
<div class="section" id="id25">
<h3><span class="section-number">1.4.1. </span>合约开发<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p>Solidity 是一门面向合约的、为实现智能合约而创建的高级编程语言。这门语言受到了 C++，Python 和 Javascript 语言的影响，设计的目的是能在虚拟机（EVM）上运行。</p>
<p>Solidity 是静态类型语言，支持继承、库和复杂的用户定义类型等特性。</p>
<div class="section" id="dockerevm">
<h4><span class="section-number">1.4.1.1. </span>通过Docker执行evm步骤<a class="headerlink" href="#dockerevm" title="Permalink to this headline">¶</a></h4>
<p>ChainMaker官方已经将容器发布至GitHub</p>
<p>拉取镜像</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker pull chainmakeroffcial/chainmaker-solidity-contract:1.1.0
</pre></div>
</div>
<p>请指定你本机的工作目录$WORK_DIR，例如C:\tmp，挂载到docker容器中以方便后续进行必要的一些文件拷贝</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker run -it --name chainmaker-solidity-contract -v <span class="nv">$WORK_DIR</span>:/home chainmakeroffcial/chainmaker-solidity-contract:1.1.0 bash
<span class="c1"># 或者先后台启动</span>
docker run -d --name chainmaker-solidity-contract -v <span class="nv">$WORK_DIR</span>:/home chainmakeroffcial/chainmaker-solidity-contract:1.1.0 bash -c <span class="s2">&quot;while true; do echo hello world; sleep 5;done&quot;</span>
<span class="c1"># 再进入容器</span>
docker <span class="nb">exec</span> -it chainmaker-solidity-contract /bin/sh
</pre></div>
</div>
<p>编译合约</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># cd /home/</span>
<span class="c1"># tar xvf /data/contract_solidity_template.tar.gz</span>
<span class="c1"># cd contract_solidity</span>
<span class="c1"># solc --abi --bin --hashes --overwrite -o . token.sol</span>
<span class="c1"># evm Token.bin init_contract data 00000000000000000000000013f0c1639a9931b0ce17e14c83f96d4732865b58</span>
</pre></div>
</div>
<p>生成的字节码在：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">contract_cpp</span><span class="o">/</span><span class="n">Token</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
<p>执行部署：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># evm Token.bin init_contract data 00000000000000000000000013f0c1639a9931b0ce17e14c83f96d4732865b58</span>
</pre></div>
</div>
<p>执行上述步骤后，把返回的result手动保存在DeployedToken.bin文件中，</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">contract_cpp</span><span class="o">/</span><span class="n">DeployedToken</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
<p>再次执行调用其中的balanceOf(address)方法，可以查到balanceOf(address)的方法签名为70a08231</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">]</span><span class="c1"># cat Token.signatures </span>
<span class="n">dd62ed3e</span><span class="p">:</span> <span class="n">allowance</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">address</span><span class="p">)</span>
<span class="mi">095</span><span class="n">ea7b3</span><span class="p">:</span> <span class="n">approve</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">uint256</span><span class="p">)</span>
<span class="mi">70</span><span class="n">a08231</span><span class="p">:</span> <span class="n">balanceOf</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="mi">42966</span><span class="n">c68</span><span class="p">:</span> <span class="n">burn</span><span class="p">(</span><span class="n">uint256</span><span class="p">)</span>
<span class="mi">313</span><span class="n">ce567</span><span class="p">:</span> <span class="n">decimals</span><span class="p">()</span>
<span class="mi">06</span><span class="n">fdde03</span><span class="p">:</span> <span class="n">name</span><span class="p">()</span>
<span class="n">c47f0027</span><span class="p">:</span> <span class="n">setName</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="n">be9a6555</span><span class="p">:</span> <span class="n">start</span><span class="p">()</span>
<span class="mi">07</span><span class="n">da68f5</span><span class="p">:</span> <span class="n">stop</span><span class="p">()</span>
<span class="mi">75</span><span class="n">f12b21</span><span class="p">:</span> <span class="n">stopped</span><span class="p">()</span>
<span class="mi">95</span><span class="n">d89b41</span><span class="p">:</span> <span class="n">symbol</span><span class="p">()</span>
<span class="mi">18160</span><span class="n">ddd</span><span class="p">:</span> <span class="n">totalSupply</span><span class="p">()</span>
<span class="n">a9059cbb</span><span class="p">:</span> <span class="n">transfer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">uint256</span><span class="p">)</span>
<span class="mi">23</span><span class="n">b872dd</span><span class="p">:</span> <span class="n">transferFrom</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">uint256</span><span class="p">)</span>
</pre></div>
</div>
<p>再次执行balanceOf(address)方法：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># evm DeployedToken.bin 0x70a08231 data 0x70a0823100000000000000000000000013f0c1639a9931b0ce17e14c83f96d4732865b58</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id26">
<h3><span class="section-number">1.4.2. </span>示例代码说明<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p><strong>Token合约</strong>示例，实现功能ERC20</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*
SPDX-License-Identifier: Apache-2.0
*/
pragma solidity &gt;0.5.11;
contract Token {

    string public name = &quot;token&quot;;      //  token name
    string public symbol = &quot;TK&quot;;           //  token symbol
    uint256 public decimals = 6;            //  token digit

    mapping (address =&gt; uint256) public balanceOf;
    mapping (address =&gt; mapping (address =&gt; uint256)) public allowance;

    uint256 public totalSupply = 0;
    bool public stopped = false;

    uint256 constant valueFounder = 100000000000000000;
    address owner = address(0x0);

    modifier isOwner {
        assert(owner == msg.sender);
        _;
    }

    modifier isRunning {
        assert (!stopped);
        _;
    }

    modifier validAddress {
        assert(address(0x0) != msg.sender);
        _;
    }

    constructor (address _addressFounder) {
        owner = msg.sender;
        totalSupply = valueFounder;
        balanceOf[_addressFounder] = valueFounder;
        
        emit Transfer(address(0x0), _addressFounder, valueFounder);
    }

    function transfer(address _to, uint256 _value) public isRunning validAddress returns (bool success) {
        require(balanceOf[msg.sender] &gt;= _value);
        require(balanceOf[_to] + _value &gt;= balanceOf[_to]);
        balanceOf[msg.sender] -= _value;
        balanceOf[_to] += _value;
        emit Transfer(msg.sender, _to, _value);
        return true;
    }

    function transferFrom(address _from, address _to, uint256 _value) public isRunning validAddress returns (bool success) {
        require(balanceOf[_from] &gt;= _value);
        require(balanceOf[_to] + _value &gt;= balanceOf[_to]);
        require(allowance[_from][msg.sender] &gt;= _value);
        balanceOf[_to] += _value;
        balanceOf[_from] -= _value;
        allowance[_from][msg.sender] -= _value;
        emit Transfer(_from, _to, _value);
        return true;
    }

    function approve(address _spender, uint256 _value) public isRunning validAddress returns (bool success) {
        require(_value == 0 || allowance[msg.sender][_spender] == 0);
        allowance[msg.sender][_spender] = _value;
        emit Approval(msg.sender, _spender, _value);
        return true;
    }

    function stop() public isOwner {
        stopped = true;
    }

    function start() public isOwner {
        stopped = false;
    }

    function setName(string memory _name) public isOwner {
        name = _name;
    }

    function burn(uint256 _value) public {
        require(balanceOf[msg.sender] &gt;= _value);
        balanceOf[msg.sender] -= _value;
        balanceOf[address(0x0)] += _value;
        emit Transfer(msg.sender, address(0x0), _value);
    }

    event Transfer(address indexed _from, address indexed _to, uint256 _value);
    event Approval(address indexed _owner, address indexed _spender, uint256 _value);
}
</pre></div>
</div>
</div>
<div class="section" id="id27">
<h3><span class="section-number">1.4.3. </span>合约发布过程<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<p>请参考：<a class="reference internal" href="chainmaker-go-sdk.html"><span class="doc">《chainmaker-go-sdk》</span></a>发送创建合约请求的部分，或者<a class="reference internal" href="chainmaker-java-sdk.html"><span class="doc">《chainmaker-java-sdk》</span></a>创建合约的部分。</p>
</div>
<div class="section" id="id28">
<h3><span class="section-number">1.4.4. </span>合约调用过程<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p>请参考：<a class="reference internal" href="chainmaker-go-sdk.html"><span class="doc">《chainmaker-go-sdk》</span></a>合约调用的部分，或者<a class="reference internal" href="chainmaker-java-sdk.html"><span class="doc">《chainmaker-java-sdk》</span></a>执行合约的部分。</p>
</div>
<div class="section" id="evm">
<h3><span class="section-number">1.4.5. </span>EVM地址说明<a class="headerlink" href="#evm" title="Permalink to this headline">¶</a></h3>
<p>ChainMaker目前已支持的证书模型与以太坊的公钥模型不相同，为此ChainMaker在SDK中支持通过证书的SKI字段转换为EVM中所支持的地址格式。</p>
<p>以下为样例证书信息部分内容：</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">Certificate</span><span class="p">:</span>
    <span class="nx">Data</span><span class="p">:</span>
        <span class="nx">Version</span><span class="p">:</span> <span class="mi">3</span> <span class="p">(</span><span class="mh">0x2</span><span class="p">)</span>
        <span class="nx">Serial</span> <span class="nx">Number</span><span class="p">:</span> <span class="mi">775620</span> <span class="p">(</span><span class="mh">0xbd5c4</span><span class="p">)</span>
    <span class="nx">Signature</span> <span class="nx">Algorithm</span><span class="p">:</span> <span class="nx">ecdsa</span><span class="o">-</span><span class="nx">with</span><span class="o">-</span><span class="nx">SHA256</span>
        <span class="nx">Issuer</span><span class="p">:</span> <span class="nx">C</span><span class="p">=</span><span class="nx">CN</span><span class="p">,</span> <span class="nx">ST</span><span class="p">=</span><span class="nx">Beijing</span><span class="p">,</span> <span class="nx">L</span><span class="p">=</span><span class="nx">Beijing</span><span class="p">,</span> <span class="nx">O</span><span class="p">=</span><span class="nx">wx</span><span class="o">-</span><span class="nx">org1</span><span class="p">.</span><span class="nx">chainmaker</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span> <span class="nx">OU</span><span class="p">=</span><span class="nx">root</span><span class="o">-</span><span class="nx">cert</span><span class="p">,</span> <span class="nx">CN</span><span class="p">=</span><span class="nx">ca</span><span class="p">.</span><span class="nx">wx</span><span class="o">-</span><span class="nx">org1</span><span class="p">.</span><span class="nx">chainmaker</span><span class="p">.</span><span class="nx">org</span>
        <span class="nx">Validity</span>
            <span class="nx">Not</span> <span class="nx">Before</span><span class="p">:</span> <span class="nx">Apr</span> <span class="mi">30</span> <span class="mo">07</span><span class="p">:</span><span class="mo">04</span><span class="p">:</span><span class="mi">20</span> <span class="mi">2021</span> <span class="nx">GMT</span>
            <span class="nx">Not</span> <span class="nx">After</span> <span class="p">:</span> <span class="nx">Apr</span> <span class="mi">29</span> <span class="mo">07</span><span class="p">:</span><span class="mo">04</span><span class="p">:</span><span class="mi">20</span> <span class="mi">2026</span> <span class="nx">GMT</span>
        <span class="nx">Subject</span><span class="p">:</span> <span class="nx">C</span><span class="p">=</span><span class="nx">CN</span><span class="p">,</span> <span class="nx">ST</span><span class="p">=</span><span class="nx">Beijing</span><span class="p">,</span> <span class="nx">L</span><span class="p">=</span><span class="nx">Beijing</span><span class="p">,</span> <span class="nx">O</span><span class="p">=</span><span class="nx">wx</span><span class="o">-</span><span class="nx">org1</span><span class="p">.</span><span class="nx">chainmaker</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span> <span class="nx">OU</span><span class="p">=</span><span class="nx">admin</span><span class="p">,</span> <span class="nx">CN</span><span class="p">=</span><span class="nx">admin1</span><span class="p">.</span><span class="nx">sign</span><span class="p">.</span><span class="nx">wx</span><span class="o">-</span><span class="nx">org1</span><span class="p">.</span><span class="nx">chainmaker</span><span class="p">.</span><span class="nx">org</span>
        <span class="nx">Subject</span> <span class="nx">Public</span> <span class="nx">Key</span> <span class="nx">Info</span><span class="p">:</span>
            <span class="nx">Public</span> <span class="nx">Key</span> <span class="nx">Algorithm</span><span class="p">:</span> <span class="nx">id</span><span class="o">-</span><span class="nx">ecPublicKey</span>
                <span class="nx">Public</span><span class="o">-</span><span class="nx">Key</span><span class="p">:</span> <span class="p">(</span><span class="mi">256</span> <span class="nx">bit</span><span class="p">)</span>
                <span class="nx">pub</span><span class="p">:</span> 
                    <span class="mo">04</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">63</span><span class="p">:</span><span class="mi">4</span><span class="nx">d</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">6</span><span class="nx">f</span><span class="p">:</span><span class="nx">b0</span><span class="p">:</span><span class="mi">3</span><span class="nx">e</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="nx">cb</span><span class="p">:</span><span class="mi">4</span><span class="nx">f</span><span class="p">:</span><span class="nx">b3</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">93</span><span class="p">:</span><span class="nx">da</span><span class="p">:</span>
                    <span class="mi">10</span><span class="p">:</span><span class="mi">1</span><span class="nx">e</span><span class="p">:</span><span class="nx">d4</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="nx">ea</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="nx">ac</span><span class="p">:</span><span class="mi">3</span><span class="nx">f</span><span class="p">:</span><span class="mi">85</span><span class="p">:</span><span class="nx">e4</span><span class="p">:</span><span class="mi">3</span><span class="nx">b</span><span class="p">:</span><span class="nx">c3</span><span class="p">:</span><span class="nx">a8</span><span class="p">:</span><span class="mi">7</span><span class="nx">e</span><span class="p">:</span><span class="nx">ff</span><span class="p">:</span>
                    <span class="mi">4</span><span class="nx">a</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">7</span><span class="nx">d</span><span class="p">:</span><span class="nx">f1</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="nx">b7</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">0</span><span class="nx">d</span><span class="p">:</span><span class="mi">94</span><span class="p">:</span><span class="mi">2</span><span class="nx">f</span><span class="p">:</span><span class="mi">9</span><span class="nx">a</span><span class="p">:</span><span class="nx">be</span><span class="p">:</span><span class="mi">92</span><span class="p">:</span><span class="mi">5</span><span class="nx">b</span><span class="p">:</span><span class="nx">dc</span><span class="p">:</span>
                    <span class="mi">90</span><span class="p">:</span><span class="nx">a2</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">75</span><span class="p">:</span><span class="mi">82</span><span class="p">:</span><span class="mi">6</span><span class="nx">e</span><span class="p">:</span><span class="mi">8</span><span class="nx">c</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="nx">ff</span><span class="p">:</span><span class="nx">f2</span><span class="p">:</span><span class="mi">96</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="nx">e2</span><span class="p">:</span><span class="nx">f4</span><span class="p">:</span>
                    <span class="nx">cc</span><span class="p">:</span><span class="nx">cf</span><span class="p">:</span><span class="nx">b7</span><span class="p">:</span><span class="mi">75</span><span class="p">:</span><span class="mi">5</span><span class="nx">d</span>
                <span class="nx">ASN1</span> <span class="nx">OID</span><span class="p">:</span> <span class="nx">prime256v1</span>
                <span class="nx">NIST</span> <span class="nx">CURVE</span><span class="p">:</span> <span class="nx">P</span><span class="o">-</span><span class="mi">256</span>
        <span class="nx">X509v3</span> <span class="nx">extensions</span><span class="p">:</span>
            <span class="nx">X509v3</span> <span class="nx">Key</span> <span class="nx">Usage</span><span class="p">:</span> <span class="nx">critical</span>
                <span class="nx">Digital</span> <span class="nx">Signature</span><span class="p">,</span> <span class="nx">Key</span> <span class="nx">Encipherment</span><span class="p">,</span> <span class="nx">Certificate</span> <span class="nx">Sign</span><span class="p">,</span> <span class="nx">CRL</span> <span class="nx">Sign</span>
            <span class="nx">X509v3</span> <span class="nx">Extended</span> <span class="nx">Key</span> <span class="nx">Usage</span><span class="p">:</span> 
                <span class="nx">Any</span> <span class="nx">Extended</span> <span class="nx">Key</span> <span class="nx">Usage</span>
						<span class="c1">// 地址由SKI(Subject Key Identifier)值HASH生成(不包括&#39;:&#39;符号)</span>
            <span class="nx">X509v3</span> <span class="nx">Subject</span> <span class="nx">Key</span> <span class="nx">Identifier</span><span class="p">:</span>               <span class="mi">08</span><span class="p">:</span><span class="nx">E6</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">3</span><span class="nx">A</span><span class="p">:</span><span class="mi">8</span><span class="nx">B</span><span class="p">:</span><span class="nx">F0</span><span class="p">:</span><span class="mi">2</span><span class="nx">B</span><span class="p">:</span><span class="nx">BB</span><span class="p">:</span><span class="nx">ED</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">71</span><span class="p">:</span><span class="nx">B4</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="nx">D0</span><span class="p">:</span><span class="nx">A5</span><span class="p">:</span><span class="nx">F1</span><span class="p">:</span><span class="nx">C4</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="nx">CC</span><span class="p">:</span><span class="nx">B6</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">6</span><span class="nx">E</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="nx">AB</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">76</span><span class="p">:</span><span class="mi">3</span><span class="nx">A</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="nx">C3</span><span class="p">:</span><span class="mi">7</span><span class="nx">B</span>
</pre></div>
</div>
<p>在ChainMaker Evm中，地址的生成参见以下流程：</p>
<p>1、SDK调合约方法，传入SKI</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">//调用blanceOf函数，查询指定用户余额。</span>

<span class="c1">//某用户SKI信息</span>
<span class="kd">const</span> <span class="nx">client1AddrSki</span> <span class="p">=</span> <span class="s">&quot;08E6253A8BF02BBBED033471B424D0A5F1C402CCB6446E4230AB51763A34C37B&quot;</span>

<span class="kd">func</span> <span class="nx">testUserContractTokenEVMBalanceOf</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">,</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">ChainClient</span><span class="p">,</span> <span class="nx">address</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">withSyncResult</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">abiJson</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">tokenABIPath</span><span class="p">)</span>
	<span class="nx">require</span><span class="p">.</span><span class="nx">Nil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>

	<span class="nx">myAbi</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">abiJson</span><span class="p">)))</span>
	<span class="nx">require</span><span class="p">.</span><span class="nx">Nil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="c1">//通过SKI生成address </span>
	<span class="nx">addrInt</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">evmutils</span><span class="p">.</span><span class="nx">MakeAddressFromHex</span><span class="p">(</span><span class="nx">client1AddrSki</span><span class="p">)</span>
	<span class="nx">addr</span> <span class="o">:=</span> <span class="nx">evmutils</span><span class="p">.</span><span class="nx">BigToAddress</span><span class="p">(</span><span class="nx">addrInt</span><span class="p">)</span>
  <span class="c1">//指定合约方法</span>
	<span class="nx">methodName</span> <span class="o">:=</span> <span class="s">&quot;balanceOf&quot;</span>
	<span class="nx">dataByte</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">myAbi</span><span class="p">.</span><span class="nx">Pack</span><span class="p">(</span><span class="nx">methodName</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
	<span class="nx">require</span><span class="p">.</span><span class="nx">Nil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>

	<span class="nx">data</span> <span class="o">:=</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">EncodeToString</span><span class="p">(</span><span class="nx">dataByte</span><span class="p">)</span>
	<span class="nx">method</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>

	<span class="nx">pairs</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">&quot;data&quot;</span><span class="p">:</span> <span class="nx">data</span><span class="p">,</span>
	<span class="p">}</span>
  <span class="c1">//调用合约</span>
	<span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">invokeUserContractWithResult</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">tokenContractName</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">pairs</span><span class="p">,</span> <span class="nx">withSyncResult</span><span class="p">)</span>
	<span class="nx">require</span><span class="p">.</span><span class="nx">Nil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>

	<span class="nx">balance</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">myAbi</span><span class="p">.</span><span class="nx">Unpack</span><span class="p">(</span><span class="nx">methodName</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
	<span class="nx">require</span><span class="p">.</span><span class="nx">Nil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;addr [%s] =&gt; %d\n&quot;</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">balance</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>2、对其HASH(Keccak256)并截取，生成address</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">MakeAddressFromHex</span><span class="p">(</span><span class="nx">str</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">DecodeString</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">MakeAddress</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">MakeAddressFromString</span><span class="p">(</span><span class="nx">str</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">MakeAddress</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">)),</span> <span class="kc">nil</span>
<span class="p">}</span>
<span class="c1">//将SKI进行HASH并截取。</span>
<span class="kd">func</span> <span class="nx">MakeAddress</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="o">*</span><span class="nx">Int</span> <span class="p">{</span>
	<span class="nx">address</span> <span class="o">:=</span> <span class="nx">Keccak256</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
	<span class="nx">addr</span> <span class="o">:=</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">EncodeToString</span><span class="p">(</span><span class="nx">address</span><span class="p">)[</span><span class="mi">24</span><span class="p">:]</span>
	<span class="k">return</span> <span class="nx">FromHexString</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">BigToAddress</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Int</span><span class="p">)</span> <span class="nx">Address</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">BytesToAddress</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">())</span> <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="SDK.html" class="btn btn-neutral float-right" title="2. SDK" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../tech/%E5%B9%B6%E8%A1%8C%E8%B0%83%E5%BA%A6.html" class="btn btn-neutral float-left" title="12. 并行调度" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright chainmaker.org.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>